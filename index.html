<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Deal Health ‚Äî Sales Large EMEA</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
<script src="data.js"></script>
<script src="coaching-engine.js"></script>
<style>
:root,[data-theme="dark"]{--bg:#0a0a0a;--s1:#141414;--s2:#1c1c1c;--s3:#242424;--b1:#2a2a2a;--b2:#3a3a3a;--t:#e8e8e8;--t2:#999;--t3:#666;--acc:#96bf48;--acc-d:rgba(150,191,72,.12);--acc-t:#96bf48;--r:#ea9999;--r-bg:rgba(234,153,153,.1);--r-b:rgba(234,153,153,.22);--y:#ffe599;--y-bg:rgba(255,229,153,.1);--y-b:rgba(255,229,153,.22);--g:#b6d7a8;--g-bg:rgba(182,215,168,.1);--g-b:rgba(182,215,168,.22);--bl:#6fa8dc;--inp-bg:#1e1e1e;--inp-b:#333}
[data-theme="light"]{--bg:#f4f5f7;--s1:#fff;--s2:#f0f1f3;--s3:#e4e5e8;--b1:#d8d9dc;--b2:#c0c1c4;--t:#1a1a1a;--t2:#555;--t3:#888;--acc:#5e8e1a;--acc-d:rgba(94,142,26,.07);--acc-t:#4a7a14;--r:#c0392b;--r-bg:rgba(192,57,43,.07);--r-b:rgba(192,57,43,.16);--y:#c89100;--y-bg:rgba(200,145,0,.07);--y-b:rgba(200,145,0,.16);--g:#1e8449;--g-bg:rgba(30,132,73,.07);--g-b:rgba(30,132,73,.16);--bl:#2471a3;--inp-bg:#fff;--inp-b:#c8c9cc}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--t);line-height:1.55;-webkit-font-smoothing:antialiased;transition:background .2s,color .2s}::selection{background:var(--acc);color:#fff}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 28px;background:var(--s1);border-bottom:1px solid var(--b1);position:sticky;top:0;z-index:200}.topbar-brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:15px;cursor:pointer;user-select:none}.topbar-brand:hover{opacity:.85}.topbar-brand span{color:var(--acc-t)}.topbar-right{display:flex;align-items:center;gap:12px}.topbar-meta{font-size:12px;color:var(--t2)}.theme-btn,.filter-btn{background:var(--s3);border:1px solid var(--b1);color:var(--t2);padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;transition:all .15s}.theme-btn:hover,.filter-btn:hover{border-color:var(--b2);color:var(--t)}.filter-btn.on{background:var(--acc-d);color:var(--acc-t);border-color:var(--acc-t)}
.container{max-width:1440px;margin:0 auto;padding:24px 28px}
.sum-row{display:grid;grid-template-columns:repeat(4,1fr);gap:11px;margin-bottom:22px}.sum-card{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px}.sum-card .lbl{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}.sum-card .val{font-size:24px;font-weight:800;font-variant-numeric:tabular-nums}.sum-card .sub{font-size:11px;color:var(--t3);margin-top:1px}
.owner-group{margin-bottom:28px}.owner-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding:0 2px}.owner-name{font-size:16px;font-weight:700}.owner-stats{display:flex;gap:12px;font-size:12px;color:var(--t2)}
table{width:100%;border-collapse:collapse;background:var(--s1);border-radius:10px;overflow:hidden;border:1px solid var(--b1);margin-bottom:4px}th{text-align:left;padding:8px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s2);border-bottom:1px solid var(--b1);white-space:nowrap}td{padding:10px 12px;font-size:12px;border-bottom:1px solid var(--b1);vertical-align:middle}tbody tr{cursor:pointer;transition:background .1s}tbody tr:hover{background:var(--s2)}tbody tr:last-child td{border-bottom:none}
.badge{display:inline-block;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700}.b-risk{background:var(--r-bg);color:var(--r);border:1px solid var(--r-b)}.b-track{background:var(--y-bg);color:var(--y);border:1px solid var(--y-b)}.b-good{background:var(--g-bg);color:var(--g);border:1px solid var(--g-b)}.b-stage{background:var(--s3);color:var(--t2);border:1px solid var(--b1)}
.sbar{width:100%;height:4px;background:var(--s3);border-radius:2px;overflow:hidden}.sbar-f{height:100%;border-radius:2px;transition:width .5s}.sbar-f.risk{background:var(--r)}.sbar-f.track{background:var(--y)}.sbar-f.good{background:var(--g)}.sbar-txt{font-size:10px;color:var(--t3);margin-top:3px;display:flex;align-items:center;gap:5px}
.back{display:inline-flex;align-items:center;gap:5px;font-size:13px;color:var(--t2);cursor:pointer;border:none;background:none;padding:5px 0;margin-bottom:12px}.back:hover{color:var(--t)}
.dh-top{display:flex;align-items:flex-start;justify-content:space-between;gap:20px;margin-bottom:14px}.dh-top h1{font-size:24px;font-weight:800}.dh-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}.chip{font-size:11px;color:var(--t2);background:var(--s2);border:1px solid var(--b1);padding:3px 9px;border-radius:5px;white-space:nowrap}
.big-score{text-align:center;background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:16px 24px;min-width:130px;flex-shrink:0}.big-score .num{font-size:40px;font-weight:900;line-height:1}.big-score .of{font-size:13px;color:var(--t3);margin-bottom:4px}
/* Products strip */
.prod-strip{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px}.prod-pill{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--acc-d);color:var(--acc-t);border:1px solid rgba(150,191,72,.25)}.prod-pill .pi{font-size:14px}
.tiles{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}.tile{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:12px;text-align:center}.tile .tl{font-size:10px;color:var(--t2);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px;font-weight:600}.tile .tv{font-size:22px;font-weight:800}.tile .tm{font-size:11px;color:var(--t3)}.tile.risk{border-color:var(--r-b)}.tile.risk .tv{color:var(--r)}.tile.track{border-color:var(--y-b)}.tile.track .tv{color:var(--y)}.tile.good{border-color:var(--g-b)}.tile.good .tv{color:var(--g)}
/* Revenue card ‚Äî simplified */
.rev-card{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:18px 20px;margin-bottom:20px}.rev-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:12px}.rev-item{text-align:center}.rev-item .rv{font-size:18px;font-weight:800;font-variant-numeric:tabular-nums}.rev-item .rl{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px}
/* Tabs */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--b1);margin-bottom:20px;overflow-x:auto}.tab{padding:8px 14px;font-size:12px;font-weight:600;color:var(--t3);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}.tab:hover{color:var(--t2)}.tab.on{color:var(--acc-t);border-bottom-color:var(--acc-t)}.pane{display:none}.pane.on{display:block}
/* Narratives ‚Äî editable */
.nar-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}.nar{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;position:relative}.nar.fw{grid-column:1/-1}.nar h3{font-size:12px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}.nar p{font-size:12px;color:var(--t2);line-height:1.7}
.edit-btn{font-size:10px;color:var(--t3);cursor:pointer;background:var(--s3);border:1px solid var(--b1);border-radius:4px;padding:2px 8px;transition:all .15s}.edit-btn:hover{color:var(--t);border-color:var(--b2)}
.nar textarea{width:100%;min-height:120px;padding:8px 10px;border-radius:6px;border:1px solid var(--inp-b);background:var(--inp-bg);color:var(--t);font-size:12px;font-family:inherit;line-height:1.7;outline:none;resize:vertical}.nar textarea:focus{border-color:var(--acc)}
.nar .save-row{display:flex;gap:6px;margin-top:8px}.nar .save-btn{padding:5px 14px;border-radius:6px;background:var(--acc);color:#fff;border:none;font-size:11px;font-weight:600;cursor:pointer}.nar .cancel-btn{padding:5px 14px;border-radius:6px;background:var(--s3);color:var(--t2);border:1px solid var(--b1);font-size:11px;cursor:pointer}
/* MEDDPICC sections */
.msec{background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:10px;overflow:hidden}.msec-h{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;user-select:none;transition:background .1s}.msec-h:hover{background:var(--s2)}.msec-t{font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px}.msec-s{font-size:12px;color:var(--t3)}.msec-b{display:none;border-top:1px solid var(--b1)}.msec.open .msec-b{display:block}.chev{transition:transform .2s;font-size:10px;color:var(--t3)}.msec.open .chev{transform:rotate(90deg)}
.mhdr{display:grid;grid-template-columns:2.2fr 58px 2fr 1.5fr 1.3fr 78px;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s2);border-bottom:1px solid var(--b1)}.mhdr>div{padding:6px 10px}.mrow{display:grid;grid-template-columns:2.2fr 58px 2fr 1.5fr 1.3fr 78px;font-size:11px;border-bottom:1px solid var(--b1)}.mrow:last-child{border-bottom:none}.mrow:hover{background:var(--s2)}.mrow>div{padding:8px 10px;line-height:1.5}.mrow .q{color:var(--t)}.mrow .ac{text-align:center;font-weight:700}.a-y{color:var(--g)}.a-n{color:var(--r)}.a-p{color:var(--y)}.mrow .nt{color:var(--t2)}.mrow .du{color:var(--t3);text-align:center;font-size:10px}
/* Editable MEDDPICC rows */
.mrow-edit textarea{width:100%;padding:4px 6px;border-radius:4px;border:1px solid var(--inp-b);background:var(--inp-bg);color:var(--t);font-size:11px;font-family:inherit;outline:none;resize:vertical;min-height:50px}.mrow-edit textarea:focus{border-color:var(--acc)}
.mrow-edit select{padding:4px 6px;border-radius:4px;border:1px solid var(--inp-b);background:var(--inp-bg);color:var(--t);font-size:11px;outline:none}
.mrow-actions{display:flex;gap:4px;padding:4px 10px 8px}.mrow-actions button{padding:3px 10px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;border:none}.mrow-actions .save-btn{background:var(--acc);color:#fff}.mrow-actions .cancel-btn{background:var(--s3);color:var(--t2);border:1px solid var(--b1)}
/* Next Steps */
.ns{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;margin-bottom:9px;border-left:3px solid var(--b1)}.ns.critical{border-left-color:var(--r)}.ns.high{border-left-color:var(--y)}.ns-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}.ns-cat{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}.ns.critical .ns-cat{color:var(--r)}.ns.high .ns-cat{color:var(--y)}.ns-issue{font-size:13px;font-weight:600;margin-bottom:4px}.ns-rec{font-size:12px;color:var(--t2);line-height:1.55}.ns-due{font-size:10px;color:var(--t3)}
/* Stakeholders */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:10px}.sc{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:10px}.av{width:36px;height:36px;border-radius:50%;background:var(--s3);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:var(--acc-t);flex-shrink:0}.av.blue{color:var(--bl)}.si{flex:1}.sn{font-size:12px;font-weight:600}.st{font-size:10px;color:var(--t2)}.se{font-size:10px;margin-top:2px}.e-h{color:var(--g)}.e-m{color:var(--y)}.e-l{color:var(--r)}.e-n{color:var(--t3)}
/* Calls */
.cc{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;margin-bottom:9px}.cc-top{display:flex;justify-content:space-between;margin-bottom:5px}.cc-title{font-size:13px;font-weight:600}.cc-date{font-size:11px;color:var(--t3)}.cc-att{font-size:11px;color:var(--t2);margin-bottom:5px}.cc-sum{font-size:12px;color:var(--t2);line-height:1.6}
/* Version History */
.vh{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;margin-bottom:9px;border-left:3px solid var(--bl)}.vh-date{font-size:13px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}.vh-score{font-size:12px;color:var(--t2)}.vh-changes{margin-top:6px}.vh-change{font-size:11px;color:var(--t2);padding:3px 0;display:flex;align-items:center;gap:6px}.vh-delta{font-weight:700;font-size:11px;padding:1px 6px;border-radius:4px}.vh-delta.up{color:var(--g);background:var(--g-bg)}.vh-delta.down{color:var(--r);background:var(--r-bg)}.vh-delta.neutral{color:var(--t3);background:var(--s3)}
/* Comments */
.cmt-section{margin-top:18px;border-top:1px solid var(--b1);padding-top:14px}.cmt-section h3{font-size:13px;margin-bottom:10px}.cmt-row{display:flex;gap:8px;margin-bottom:12px}.cmt-inp{flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--inp-b);background:var(--inp-bg);color:var(--t);font-size:12px;outline:none;font-family:inherit}.cmt-inp:focus{border-color:var(--acc)}.cmt-row button{padding:8px 16px;border-radius:8px;background:var(--acc);color:#fff;border:none;font-size:12px;font-weight:600;cursor:pointer}.cmt{background:var(--s2);border-radius:8px;padding:9px 12px;margin-bottom:6px}.cmt-top{display:flex;justify-content:space-between;margin-bottom:3px}.cmt-author{font-size:11px;font-weight:600}.cmt-time{font-size:9px;color:var(--t3)}.cmt-text{font-size:12px;color:var(--t2);line-height:1.55}.cmt-del{font-size:9px;color:var(--t3);cursor:pointer;margin-left:6px}.cmt-del:hover{color:var(--r)}
/* Org Chart */
.org-chart-container{padding:20px 0;overflow-x:auto}
.org-tree{display:flex;flex-direction:column;align-items:center;gap:0;min-width:fit-content}
.org-node-wrap{display:flex;flex-direction:column;align-items:center;position:relative}
.org-node{background:var(--s1);border:1.5px solid var(--b1);border-radius:10px;padding:14px 18px;min-width:180px;max-width:220px;text-align:center;cursor:grab;user-select:none;transition:all .2s;position:relative;z-index:2}
.org-node:hover{border-color:var(--acc);box-shadow:0 2px 12px rgba(150,191,72,.15)}
.org-node:active{cursor:grabbing;opacity:.85}
.org-node.dragging{opacity:.4;border-style:dashed}
.org-node.drag-over{border-color:var(--acc);background:var(--acc-d);box-shadow:0 0 0 3px rgba(150,191,72,.2)}
.org-node .on-avatar{width:40px;height:40px;border-radius:50%;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.org-node .on-avatar.merchant{background:var(--s3);color:var(--acc-t)}
.org-node .on-avatar.shopify{background:rgba(111,168,220,.15);color:var(--bl)}
.org-node .on-name{font-size:12px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.org-node .on-title{font-size:10px;color:var(--t2);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.org-node .on-role{font-size:8px;font-weight:700;padding:2px 7px;border-radius:3px;display:inline-block}
.org-node .on-role.dm{background:var(--r-bg);color:var(--r);border:1px solid var(--r-b)}
.org-node .on-role.ev{background:var(--y-bg);color:var(--y);border:1px solid var(--y-b)}
.org-node .on-role.inf{background:var(--g-bg);color:var(--g);border:1px solid var(--g-b)}
.org-node .on-role.ch{background:rgba(111,168,220,.1);color:var(--bl);border:1px solid rgba(111,168,220,.22)}
.org-node .on-eng{margin-top:6px;font-size:9px;color:var(--t3)}
.org-node .on-eng .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:3px}
.org-node .on-eng .dot.high{background:var(--g)}.org-node .on-eng .dot.medium{background:var(--y)}.org-node .on-eng .dot.low{background:var(--r)}.org-node .on-eng .dot.none{background:var(--t3)}
.org-children{display:flex;gap:0;justify-content:center;position:relative}
.org-children::before{content:'';position:absolute;top:0;left:50%;width:0;height:20px;border-left:1.5px solid var(--b2)}
.org-child-branch{display:flex;flex-direction:column;align-items:center;position:relative;padding:0 12px}
.org-child-branch::before{content:'';position:absolute;top:0;width:50%;height:20px;border-top:1.5px solid var(--b2)}
.org-child-branch:first-child::before{left:50%;border-left:1.5px solid var(--b2);border-top-left-radius:6px}
.org-child-branch:last-child::before{right:50%;left:auto;border-right:1.5px solid var(--b2);border-top-right-radius:6px}
.org-child-branch:only-child::before{border-top:none;border-left:1.5px solid var(--b2);left:50%;width:0}
.org-child-branch .org-connector{width:0;height:20px;border-left:1.5px solid var(--b2)}
.org-connector-down{width:0;height:20px;border-left:1.5px solid var(--b2)}
.org-drop-zone{min-height:40px;min-width:120px;border:1.5px dashed var(--b2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--t3);margin:8px 0;padding:8px;transition:all .2s;opacity:0}
.org-drop-zone.visible{opacity:1}
.org-drop-zone.drag-over{border-color:var(--acc);background:var(--acc-d);color:var(--acc-t)}
.org-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.org-toolbar h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
.org-toolbar-actions{display:flex;gap:6px}
.org-btn{padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--b1);background:var(--s3);color:var(--t2);transition:all .15s}
.org-btn:hover{border-color:var(--b2);color:var(--t)}
.org-btn.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
.org-btn.primary:hover{opacity:.9}
.org-legend{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.org-legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--t3)}
.org-legend-dot{width:8px;height:8px;border-radius:50%}
.org-unassigned{margin-top:20px;padding:16px;background:var(--s2);border:1px dashed var(--b2);border-radius:10px}
.org-unassigned h4{font-size:12px;font-weight:600;color:var(--t2);margin-bottom:10px}
.org-unassigned-list{display:flex;flex-wrap:wrap;gap:8px}
.org-unassigned .org-node{min-width:160px;max-width:180px;padding:10px 14px}
.org-side-label{position:absolute;top:8px;right:8px;font-size:8px;padding:1px 5px;border-radius:3px;background:var(--s3);color:var(--t3)}
/* MAP table */
.map-tbl{width:100%;border-collapse:collapse;background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;margin-bottom:16px}.map-tbl th{text-align:left;padding:8px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s2);border-bottom:1px solid var(--b1);white-space:nowrap}.map-tbl td{padding:8px 12px;font-size:11px;border-bottom:1px solid var(--b1);vertical-align:middle}.map-tbl tr:last-child td{border-bottom:none}.map-tbl tr.map-done td{opacity:.5}.map-tbl tr.map-done td:nth-child(3){text-decoration:line-through}.map-tbl .map-check{accent-color:var(--acc);width:16px;height:16px;cursor:pointer}.map-tbl .map-bold{font-weight:700}.map-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--s2);border:1px solid var(--b1);border-radius:10px 10px 0 0;margin-bottom:0}.map-hdr h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}.map-progress{display:flex;align-items:center;gap:10px}.map-progress .mp-bar{width:120px;height:6px;background:var(--s3);border-radius:3px;overflow:hidden}.map-progress .mp-fill{height:100%;border-radius:3px;transition:width .5s}.map-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 16px;background:var(--s1);border:1px solid var(--b1);border-top:none;margin-bottom:16px}.map-info-item{font-size:12px}.map-info-label{font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
/* Coaching drilldown */
.coach-modal{position:fixed;top:0;left:0;right:0;bottom:0;z-index:250;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;padding:20px}.coach-panel{background:var(--bg);border:1px solid var(--b1);border-radius:14px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:0}.coach-panel-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--b1);position:sticky;top:0;background:var(--bg);z-index:1;border-radius:14px 14px 0 0}.coach-panel-head h2{font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px}.coach-close{background:var(--s3);border:1px solid var(--b1);color:var(--t2);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}.coach-close:hover{color:var(--t);border-color:var(--b2)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--acc);color:#fff;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;opacity:0;transition:opacity .3s;pointer-events:none;z-index:300}.toast.show{opacity:1}
.hidden{display:none!important}.money{font-variant-numeric:tabular-nums}
@media(max-width:900px){.sum-row{grid-template-columns:repeat(2,1fr)}.tiles{grid-template-columns:repeat(2,1fr)}.nar-grid,.sg{grid-template-columns:1fr}.mrow,.mhdr{grid-template-columns:2fr 50px 2.5fr 0 0 0}.mrow>div:nth-child(n+4),.mhdr>div:nth-child(n+4){display:none}}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-brand" onclick="goHome()"><span>‚ö°</span> Deal Health Dashboard</div>
  <div class="topbar-right">
    <div class="topbar-meta" id="topbar-meta">Sales Large ‚Äî EMEA</div>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-toggle">‚òÄÔ∏è Light</button>
  </div>
</div>
<div class="container">
  <div id="v-list"></div>
  <div id="v-detail" class="hidden"></div>
</div>
<div class="toast" id="toast">‚úì Saved</div>
<script>
// ============================================================
// LOCAL EDITS STORAGE
// ============================================================
function getEdits(oppId){try{return JSON.parse(localStorage.getItem('edits_'+oppId)||'{}')}catch(e){return{}}}
function saveEdit(oppId,key,value){const e=getEdits(oppId);e[key]=value;localStorage.setItem('edits_'+oppId,JSON.stringify(e));toast('‚úì Edit saved locally')}
function getEditedValue(opp,path){const e=getEdits(opp.id);if(e[path]!==undefined)return e[path];const parts=path.split('.');let v=opp;for(const p of parts){if(v==null)return'';v=v[p]}return v||''}

// ============================================================
// GITHUB COMMENTS API
// ============================================================
const GH_REPO='ShivPatel15/deal-health-dashboard';
const GH_COMMENTS_PATH='comments.json';
let ghComments={};let ghSha=null;let ghToken=localStorage.getItem('gh_token')||'';
async function loadCloudComments(){try{const r=await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${GH_COMMENTS_PATH}`,{headers:ghToken?{'Authorization':`token ${ghToken}`}:{}});if(!r.ok)return;const d=await r.json();ghSha=d.sha;ghComments=JSON.parse(atob(d.content))}catch(e){console.log('Cloud comments unavailable:',e.message)}}
async function saveCloudComments(){if(!ghToken){ghToken=prompt('Enter your GitHub token (repo scope) to save comments to cloud.\nGet one at github.com/settings/tokens\n\nCancel for local-only.');if(!ghToken)return false;localStorage.setItem('gh_token',ghToken)}try{const body=JSON.stringify(ghComments,null,2);const r=await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${GH_COMMENTS_PATH}`,{method:'PUT',headers:{'Authorization':`token ${ghToken}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Update comments',content:btoa(unescape(encodeURIComponent(body))),sha:ghSha})});if(!r.ok)throw new Error('Save failed');const d=await r.json();ghSha=d.content.sha;return true}catch(e){console.error(e);return false}}
function getComments(oppId){return ghComments[oppId]||[]}
async function addComment(oppId,text,author){if(!ghComments[oppId])ghComments[oppId]=[];ghComments[oppId].push({id:Date.now()+'',author,text,ts:new Date().toISOString()});const ok=await saveCloudComments();toast(ok?'‚òÅÔ∏è Saved to cloud':'Saved locally')}
async function deleteComment(oppId,cmtId){if(!ghComments[oppId])return;ghComments[oppId]=ghComments[oppId].filter(c=>c.id!==cmtId);await saveCloudComments()}

// ============================================================
// THEME
// ============================================================
function toggleTheme(){const h=document.documentElement,n=h.dataset.theme==='dark'?'light':'dark';h.dataset.theme=n;localStorage.setItem('theme',n);document.getElementById('theme-toggle').textContent=n==='dark'?'‚òÄÔ∏è Light':'üåô Dark'}
(()=>{const s=localStorage.getItem('theme')||'dark';document.documentElement.dataset.theme=s;document.getElementById('theme-toggle').textContent=s==='dark'?'‚òÄÔ∏è Light':'üåô Dark'})();

// ============================================================
// HELPERS
// ============================================================
const opps=DEAL_DATA.opportunities;
const owners=DEAL_DATA.owners||[];
const fmt=n=>n==null||n===0?'‚Äî':'$'+n.toLocaleString('en-US');
const fmtK=n=>n==null||n===0?'‚Äî':n>=1e6?'$'+(n/1e6).toFixed(1)+'M':n>=1e3?'$'+Math.round(n/1e3)+'K':'$'+n;
const bCls=s=>({'at-risk':'b-risk','on-track':'b-track','good-health':'b-good'})[s]||'b-stage';
const barC=s=>({'at-risk':'risk','on-track':'track','good-health':'good'})[s]||'track';
const sLbl=s=>({'at-risk':'At Risk','on-track':'On Track','good-health':'Good Health'})[s]||s;
const badge=(s,cls)=>`<span class="badge ${cls||bCls(s)}">${typeof cls!=='undefined'?s:sLbl(s)}</span>`;
const aCls=a=>({Yes:'a-y',No:'a-n',Partial:'a-p'})[a]||'';
const eCls=e=>({high:'e-h',medium:'e-m',low:'e-l',none:'e-n'})[e]||'';
const ini=n=>n.split(' ').map(w=>w[0]).join('').slice(0,2);
const tCls=p=>p<50?'risk':p<75?'track':'good';
const ago=ts=>{const d=Math.floor((Date.now()-new Date(ts))/1e3);return d<60?'now':d<3600?Math.floor(d/60)+'m':d<86400?Math.floor(d/3600)+'h':Math.floor(d/86400)+'d'};
function toast(msg='‚úì Saved'){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
let currentOpp=null;let filterOwner=null;let filterQuarter=null;let filterStage=null;let filterHealth=null;

// ============================================================
// QUARTER / MONTH HELPERS
// ============================================================
function getQuarter(dateStr){
  const d=new Date(dateStr);
  const q=Math.ceil((d.getMonth()+1)/3);
  return 'Q'+q+' '+d.getFullYear();
}
function getMonthKey(dateStr){
  const d=new Date(dateStr);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
}
function getMonthLabel(monthKey){
  const [y,m]=monthKey.split('-');
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[parseInt(m)-1]+' '+y;
}
function getAvailableQuarters(){
  const qs=new Set();
  opps.forEach(o=>{if(o.closeDate)qs.add(getQuarter(o.closeDate))});
  return [...qs].sort((a,b)=>{
    const [qa,ya]=a.match(/Q(\d) (\d{4})/).slice(1);
    const [qb,yb]=b.match(/Q(\d) (\d{4})/).slice(1);
    return ya!==yb?ya-yb:qa-qb;
  });
}
function getAvailableStages(){
  const s=new Set();opps.forEach(o=>{if(o.stage)s.add(o.stage)});
  const order=['Deal Craft','Demonstrate','Solution','Envision','Pre-Qualified'];
  return[...s].sort((a,b)=>(order.indexOf(a)===-1?99:order.indexOf(a))-(order.indexOf(b)===-1?99:order.indexOf(b)));
}

// ============================================================
// DAILY UPDATE ‚Äî what changed in the most recent refresh
// ============================================================
function duClick(id){showDetail(id)}
function duToggle(){var b=document.getElementById("daily-body");if(!b)return;b.classList.toggle("hidden");var ch=document.getElementById("du-chev");if(ch)ch.textContent=b.classList.contains("hidden")?"‚ñ∂":"‚ñº"}
function buildDailyUpdate(){
  var rds=new Date(DEAL_DATA.generatedAt).toISOString().split("T")[0];
  var rdl=new Date(DEAL_DATA.generatedAt).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
  var changed=[],today=[];
  opps.forEach(function(o){var h=o.history||[];if(!h.length)return;var l=h[h.length-1];if(l.date===rds){today.push(o);if(l.changes&&l.changes.length>0)changed.push(o)}});
  if(!today.length)return "";
  var hrDeals=opps.filter(function(o){return(o.dealRisks||[]).some(function(r){return r.severity==="high"})});
  var up=0,dn=0;
  changed.forEach(function(o){var h=o.history,l=h[h.length-1],p=h.length>1?h[h.length-2]:null;if(p&&l.totalScore>p.totalScore)up++;if(p&&l.totalScore<p.totalScore)dn++});
  var h="";
  h+="<div style=\"background:var(--s1);border:1px solid var(--b1);border-radius:12px;margin-bottom:22px;overflow:hidden\">";
  h+="<div style=\"padding:14px 18px;background:var(--s2);border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;cursor:pointer\" onclick=\"duToggle()\">";
  h+="<div style=\"display:flex;align-items:center;gap:10px\"><span style=\"font-size:18px\">\uD83D\uDCF0</span><div>";
  h+="<div style=\"font-size:15px;font-weight:800\">Daily Update</div>";
  h+="<div style=\"font-size:11px;color:var(--t3)\">"+rdl+"</div>";
  h+="</div></div>";
  h+="<div style=\"display:flex;align-items:center;gap:8px\">";
  if(up)h+="<span style=\"font-size:10px;font-weight:700;color:var(--g);background:var(--g-bg);padding:2px 8px;border-radius:4px;border:1px solid var(--g-b)\">\u25B2 "+up+" improved</span>";
  if(dn)h+="<span style=\"font-size:10px;font-weight:700;color:var(--r);background:var(--r-bg);padding:2px 8px;border-radius:4px;border:1px solid var(--r-b)\">\u25BC "+dn+" declined</span>";
  if(hrDeals.length)h+="<span style=\"font-size:10px;font-weight:700;color:var(--r);background:var(--r-bg);padding:2px 8px;border-radius:4px;border:1px solid var(--r-b)\">\uD83D\uDEA8 "+hrDeals.length+" high-risk</span>";
  h+="<span style=\"font-size:10px;color:var(--t3)\">"+today.length+"/"+opps.length+" refreshed</span>";
  h+="<span style=\"font-size:10px;color:var(--t3)\" id=\"du-chev\">\u25BC</span>";
  h+="</div></div>";
  h+="<div id=\"daily-body\"><div style=\"padding:14px 18px\">";
  if(changed.length){
    h+="<div style=\"margin-bottom:16px\"><div style=\"font-size:12px;font-weight:700;color:var(--t2);margin-bottom:10px\">\uD83D\uDCCA Score Changes</div>";
    h+="<div style=\"display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:8px\">";
    changed.forEach(function(o){
      var hi=o.history,la=hi[hi.length-1],pr=hi.length>1?hi[hi.length-2]:null;
      var d=pr?(la.totalScore-pr.totalScore):0;var bc=d>0?"g":d<0?"r":"y";
      var sd=[];
      if(pr&&la.sectionScores&&pr.sectionScores){Object.keys(la.sectionScores).forEach(function(k){var nv=la.sectionScores[k],ov=pr.sectionScores[k];if(ov!=null&&nv!==ov)sd.push({s:k,d:nv-ov})})}
      h+="<div style=\"background:var(--s1);border:1px solid var(--b1);border-left:3px solid var(--"+bc+");border-radius:8px;padding:10px 14px;cursor:pointer\" onclick=\"duClick(&quot;"+o.id+"&quot;)\">";
      h+="<div style=\"display:flex;align-items:center;justify-content:space-between;margin-bottom:6px\">";
      h+="<div style=\"display:flex;align-items:center;gap:6px\"><span style=\"font-size:13px;font-weight:700\">"+o.accountName+"</span><span class=\"badge b-stage\" style=\"font-size:8px\">"+o.stage+"</span></div>";
      h+="<div style=\"display:flex;align-items:center;gap:6px\">";
      if(pr)h+="<span style=\"font-size:12px;color:var(--t3)\">"+pr.totalScore+"</span><span style=\"font-size:10px;color:var(--t3)\">\u2192</span>";
      h+="<span style=\"font-size:14px;font-weight:800;color:var(--"+bc+")\">"+la.totalScore+"/"+la.totalMax+"</span>";
      if(d!==0)h+="<span style=\"font-size:11px;font-weight:700;color:var(--"+bc+");background:var(--"+bc+"-bg);padding:1px 5px;border-radius:3px\">"+(d>0?"+":"")+d+"</span>";
      h+="</div></div>";
      if(sd.length){h+="<div style=\"display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px\">";sd.forEach(function(x){var cl=x.d>0?"g":"r";h+="<span style=\"font-size:9px;padding:1px 5px;border-radius:3px;background:var(--"+cl+"-bg);color:var(--"+cl+");border:1px solid var(--"+cl+"-b)\">"+x.s+" "+(x.d>0?"+":"")+x.d+"</span>"});h+="</div>"}
      if(la.changes&&la.changes.length){h+="<div style=\"font-size:10px;color:var(--t2);line-height:1.5\">";la.changes.slice(0,3).forEach(function(c){h+="\u2022 "+c+"<br>"});h+="</div>"}
      h+="</div>";
    });
    h+="</div></div>";
  }
  if(hrDeals.length){
    h+="<div style=\"margin-bottom:16px\"><div style=\"font-size:12px;font-weight:700;color:var(--t2);margin-bottom:10px\">\uD83D\uDEA8 High-Priority Risks</div>";
    h+="<div style=\"display:flex;flex-direction:column;gap:6px\">";
    hrDeals.forEach(function(o){(o.dealRisks||[]).filter(function(r){return r.severity==="high"}).forEach(function(r){
      h+="<div style=\"background:var(--r-bg);border:1px solid var(--r-b);border-radius:6px;padding:8px 12px;font-size:11px;line-height:1.5;display:flex;align-items:flex-start;gap:8px;cursor:pointer\" onclick=\"duClick(&quot;"+o.id+"&quot;)\">";
      h+="<span style=\"font-size:8px;font-weight:700;color:var(--r);background:var(--s1);padding:1px 5px;border-radius:3px;flex-shrink:0;margin-top:2px\">HIGH</span>";
      h+="<div><span style=\"font-weight:700;color:var(--acc-t)\">"+o.accountName+"</span> <span style=\"color:var(--t2)\">"+r.risk+"</span></div></div>";
    })});
    h+="</div></div>";
  }
  var nc=today.filter(function(o){var hi=o.history||[];var l=hi[hi.length-1];return!l.changes||l.changes.length===0});
  if(nc.length){
    h+="<div style=\"padding:8px 12px;background:var(--s2);border-radius:6px;font-size:11px;color:var(--t3)\">";
    h+="<span style=\"font-weight:700\">"+nc.length+" deal"+(nc.length>1?"s":"")+" unchanged:</span> ";
    h+=nc.map(function(o){return "<span style=\"cursor:pointer;color:var(--t2)\" onclick=\"duClick(&quot;"+o.id+"&quot;)\">"+o.accountName+"</span>"}).join(", ");
    h+="</div>";
  }
  h+="</div></div></div>";
  return h;
}

// ============================================================
// PORTFOLIO VIEW
// ============================================================
function renderList(){
  document.getElementById('v-detail').classList.add('hidden');
  const el=document.getElementById('v-list');el.classList.remove('hidden');

  // Apply all filters
  let filtered=opps;
  if(filterOwner)filtered=filtered.filter(o=>o.owner===filterOwner);
  if(filterQuarter)filtered=filtered.filter(o=>getQuarter(o.closeDate)===filterQuarter);
  if(filterStage)filtered=filtered.filter(o=>o.stage===filterStage);
  if(filterHealth)filtered=filtered.filter(o=>o.scores?._total?.status===filterHealth);

  const totalRev=filtered.reduce((s,o)=>s+(o.revenue?.totalRev3yr||0),0);
  const totalPbr=filtered.reduce((s,o)=>s+(o.projectedBilledRevenue||0),0);
  const avgHealth=filtered.length?Math.round(filtered.reduce((s,o)=>s+(o.scores?._total?.pct||0),0)/filtered.length):0;
  const atRisk=filtered.filter(o=>o.scores?._total?.status==='at-risk').length;

  // Build filter bar
  const quarters=getAvailableQuarters();
  const stages=getAvailableStages();
  const activeCount=[filterOwner,filterQuarter,filterStage,filterHealth].filter(Boolean).length;

  const filterHtml=`<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;margin-bottom:18px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:var(--t2);display:flex;align-items:center;gap:6px">üîç Filters${activeCount?` <span style="background:var(--acc);color:#fff;font-size:9px;padding:1px 6px;border-radius:10px">${activeCount} active</span>`:''}</div>
      ${activeCount?`<button class="filter-btn" onclick="clearAllFilters()" style="font-size:10px">‚úï Clear All</button>`:''}
    </div>

    <!-- Close Quarter (primary filter) -->
    <div style="margin-bottom:8px">
      <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Close Quarter</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button class="filter-btn${!filterQuarter?' on':''}" onclick="setQuarter(null)">All</button>
        ${quarters.map(q=>{const c=opps.filter(o=>getQuarter(o.closeDate)===q).length;return`<button class="filter-btn${filterQuarter===q?' on':''}" onclick="setQuarter('${q}')">${q} <span style="opacity:.6">(${c})</span></button>`}).join('')}
      </div>
    </div>

    <!-- Owner + Stage + Health row -->
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      ${owners.length>1?`<div>
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Owner</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap">
          <button class="filter-btn${!filterOwner?' on':''}" onclick="setFilter(null)">All</button>
          ${owners.map(ow=>{const c=opps.filter(o=>o.owner===ow).length;return`<button class="filter-btn${filterOwner===ow?' on':''}" onclick="setFilter('${ow}')">${ow.split(' ')[0]} <span style="opacity:.6">(${c})</span></button>`}).join('')}
        </div>
      </div>`:''}

      <div>
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Stage</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap">
          <button class="filter-btn${!filterStage?' on':''}" onclick="setStage(null)">All</button>
          ${stages.map(st=>{const c=opps.filter(o=>o.stage===st).length;return`<button class="filter-btn${filterStage===st?' on':''}" onclick="setStage('${st}')">${st} <span style="opacity:.6">(${c})</span></button>`}).join('')}
        </div>
      </div>

      <div>
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Health</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap">
          <button class="filter-btn${!filterHealth?' on':''}" onclick="setHealth(null)">All</button>
          <button class="filter-btn${filterHealth==='at-risk'?' on':''}" onclick="setHealth('at-risk')"><span style="color:var(--r)">‚óè</span> At Risk</button>
          <button class="filter-btn${filterHealth==='on-track'?' on':''}" onclick="setHealth('on-track')"><span style="color:var(--y)">‚óè</span> On Track</button>
          <button class="filter-btn${filterHealth==='good-health'?' on':''}" onclick="setHealth('good-health')"><span style="color:var(--g)">‚óè</span> Good</button>
        </div>
      </div>
    </div>
  </div>`;

  const grouped={};(filterOwner?[filterOwner]:owners.length?owners:['All']).forEach(ow=>{
    grouped[ow]=(filterOwner?filtered:opps.filter(o=>owners.length?o.owner===ow:true)).sort((a,b)=>{
      const so={'Deal Craft':0,Demonstrate:1,Solution:2,Envision:3,'Pre-Qualified':4};
      return(so[a.stage]||9)-(so[b.stage]||9)||new Date(a.closeDate)-new Date(b.closeDate)});
  });

  const dailyUpdateHtml=buildDailyUpdate();

  let html=`<h2 style="font-size:20px;font-weight:800;margin-bottom:3px">Pipeline Overview</h2>
  <p style="color:var(--t3);font-size:12px;margin-bottom:14px">Data as of ${new Date(DEAL_DATA.generatedAt).toLocaleDateString()} ¬∑ ${filtered.length} opportunities</p>
  ${dailyUpdateHtml}
  ${filterHtml}
  <div class="sum-row">
    <div class="sum-card"><div class="lbl">Opportunities</div><div class="val">${filtered.length}</div></div>
    <div class="sum-card"><div class="lbl">Total Proj Billed Rev</div><div class="val money">${fmtK(totalPbr)}</div></div>
    <div class="sum-card"><div class="lbl">Avg Health</div><div class="val">${avgHealth}%</div></div>
    <div class="sum-card"><div class="lbl">At Risk</div><div class="val" style="color:${atRisk?'var(--r)':'var(--g)'}">${atRisk}</div></div>
  </div>`;

  // DEAL RISK SIGNALS ‚Äî grouped by deal, collapsible
  const allRisks=[];
  filtered.forEach(o=>{getDealRisks(o).forEach(r=>allRisks.push({...r,opp:o}))});
  // Group risks by deal
  const risksByDeal={};
  allRisks.forEach(r=>{const id=r.opp.id;if(!risksByDeal[id])risksByDeal[id]={opp:r.opp,risks:[]};risksByDeal[id].risks.push(r)});
  // Sort deals by highest severity risk first, then by count
  const sevOrd={"high":0,"med":1,"low":2};
  const dealRiskArr=Object.values(risksByDeal).sort((a,b)=>{
    const aMax=Math.min(...a.risks.map(r=>sevOrd[r.sev]||9));
    const bMax=Math.min(...b.risks.map(r=>sevOrd[r.sev]||9));
    return aMax!==bMax?aMax-bMax:b.risks.length-a.risks.length;
  });
  const totalRiskCount=allRisks.length;
  const highCount=allRisks.filter(r=>r.sev==="high").length;
  if(totalRiskCount){
    html+=`<div style="margin-bottom:24px">
    <h3 style="font-size:16px;font-weight:800;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:6px" onclick="const b=document.getElementById('risk-body');b.classList.toggle('hidden');this.querySelector('.sec-chev').textContent=b.classList.contains('hidden')?'‚ñ∂':'‚ñº'">\u{1F6A8} Deal Risks <span style="font-size:11px;color:var(--t3);font-weight:400">${totalRiskCount} signals across ${dealRiskArr.length} deal${dealRiskArr.length>1?'s':''}</span>${highCount?` <span class="badge b-risk">${highCount} HIGH</span>`:``} <span class="sec-chev" style="font-size:10px;color:var(--t3)">‚ñº</span></h3>
    <div id="risk-body" class="hidden">
    <p style="color:var(--t3);font-size:11px;margin-bottom:12px">Grouped by deal. Each risk includes a coaching suggestion. Click deal name to expand/collapse.</p>
    ${dealRiskArr.map((d,di)=>{
      const o=d.opp,rs=d.risks;
      const dHigh=rs.filter(r=>r.sev==="high").length;
      const dMed=rs.filter(r=>r.sev==="med").length;
      const dLow=rs.filter(r=>r.sev==="low").length;
      const worstSev=dHigh?"r":dMed?"y":"t3";
      const dtc=Math.ceil((new Date(o.closeDate)-Date.now())/864e5);
      const bodyId="risk-deal-"+di;
      return`<div style="border:1px solid var(--b1);border-left:3px solid var(--${worstSev});border-radius:8px;margin-bottom:8px;overflow:hidden">
        <div style="padding:10px 14px;background:var(--s2);cursor:pointer;display:flex;align-items:center;gap:8px;flex-wrap:wrap" onclick="const b=document.getElementById('${bodyId}');b.classList.toggle('hidden');this.querySelector('.deal-chev').textContent=b.classList.contains('hidden')?'‚ñ∂':'‚ñº'">
          <span class="deal-chev" style="font-size:10px;color:var(--t3)">‚ñ∂</span>
          <span style="font-size:13px;font-weight:700;color:var(--acc-t);cursor:pointer" onclick="event.stopPropagation();showDetail('${o.id}')">${o.accountName}</span>
          <span style="font-size:10px;color:var(--t3)">${o.owner} ¬∑ Close ${dtc}d</span>
          <span style="margin-left:auto;display:flex;gap:4px">
            ${dHigh?`<span style="font-size:8px;font-weight:700;color:var(--r);background:var(--r-bg);padding:1px 5px;border-radius:3px;border:1px solid var(--r-b)">${dHigh} HIGH</span>`:''}
            ${dMed?`<span style="font-size:8px;font-weight:700;color:var(--y);background:var(--y-bg);padding:1px 5px;border-radius:3px;border:1px solid var(--y-b)">${dMed} MED</span>`:''}
            ${dLow?`<span style="font-size:8px;font-weight:700;color:var(--t3);background:var(--s2);padding:1px 5px;border-radius:3px;border:1px solid var(--b1)">${dLow} LOW</span>`:''}
          </span>
        </div>
        <div id="${bodyId}" class="hidden" style="padding:8px 14px 10px">
          ${rs.sort((a,b)=>(sevOrd[a.sev]||9)-(sevOrd[b.sev]||9)).map(r=>{const sc=r.sev==="high"?"r":r.sev==="med"?"y":"t3";const sb=r.sev==="high"?"r-bg":r.sev==="med"?"y-bg":"s2";const bd=r.sev==="high"?"r-b":r.sev==="med"?"y-b":"b1";const sl=r.sev==="high"?"HIGH":r.sev==="med"?"MED":"LOW";
            return`<div style="background:var(--${sb});border:1px solid var(--${bd});border-left:3px solid var(--${sc});border-radius:6px;padding:8px 12px;margin-bottom:5px">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
                <span style="font-size:8px;font-weight:700;color:var(--${sc});background:var(--s1);padding:1px 5px;border-radius:3px">${sl}</span>
                <span style="font-size:12px;color:var(--t)">${r.signal}</span>
              </div>
              <div style="font-size:11px;color:var(--t2);background:var(--s1);border-radius:5px;padding:5px 9px;border-left:2px solid var(--acc)">\u{1F4A1} ${r.coaching}</div>
            </div>`}).join("")}
        </div>
      </div>`}).join("")}</div></div>`;
  }

  // REP COACHING
  const coachOwners=filterOwner?[filterOwner]:owners.length?owners:[];
  if(coachOwners.length){
    html+=`<div style="margin-bottom:24px">
    <h3 style="font-size:16px;font-weight:800;margin-bottom:4px">\u{1F3AF} Rep Coaching</h3>
    <p style="color:var(--t3);font-size:11px;margin-bottom:12px">MEDDPICC patterns across each rep. Spot skill gaps vs deal-specific issues.</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:12px">
    ${coachOwners.map(ow=>{
      const owD=opps.filter(o=>o.owner===ow);if(!owD.length)return"";
      const c=getRepCoaching(ow,owD);
      return`<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;cursor:pointer" onclick="showCoachingDrilldown('${ow}')">
        <div style="padding:12px 14px;border-bottom:1px solid var(--b1);background:var(--s2);display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="width:28px;height:28px;border-radius:50%;background:var(--s3);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bl)">${ini(ow)}</span>
            <div><div style="font-size:13px;font-weight:700">${ow}</div><div style="font-size:10px;color:var(--t3)">${owD.length} deal${owD.length>1?"s":""} ¬∑ <span style="color:var(--acc-t)">click for trends ‚Üí</span></div></div>
          </div>
          <div style="text-align:right"><div style="font-size:9px;color:var(--t3)">FOCUS AREA</div><div style="font-size:12px;font-weight:700;color:var(--r)">${c.weakest.name}</div></div>
        </div>
        <div style="padding:10px 14px">
          ${c.ranked.map((s,i)=>{const bc=s.pct<40?"r":s.pct<65?"y":"g";const iw=i===0;
            return`<div style="display:flex;align-items:center;gap:8px;padding:3px 0${iw?";background:var(--r-bg);margin:0 -14px;padding:3px 14px;border-radius:3px":""}">
              <div style="width:110px;font-size:10px;${iw?"font-weight:700;color:var(--r)":"color:var(--t2)"};flex-shrink:0">${s.name}</div>
              <div style="flex:1;height:5px;background:var(--s3);border-radius:3px;overflow:hidden"><div style="width:${s.pct}%;height:100%;background:var(--${bc});border-radius:3px"></div></div>
              <div style="width:36px;text-align:right;font-size:10px;font-weight:700;color:var(--${bc})">${s.pct}%</div>
            </div>`}).join("")}
          <div style="margin-top:10px;padding:8px 10px;background:var(--s2);border-radius:6px;border-left:2px solid var(--acc)">
            <div style="font-size:9px;font-weight:700;color:var(--acc-t);margin-bottom:3px">\u{1F4A1} 1:1 COACHING</div>
            <div style="font-size:11px;color:var(--t);line-height:1.6">${coachTip(ow,c)}</div>
          </div>
        </div>
      </div>`}).join("")}
    </div></div>`;
  }

  // ============================================================
  // ACTION ITEMS SECTION ‚Äî grouped by rep ‚Üí deal (compact table)
  // ============================================================
  html+=`<div style="margin-bottom:28px">
    <h3 style="font-size:16px;font-weight:800;margin-bottom:4px">üìã Action Items</h3>
    <p style="color:var(--t3);font-size:11px;margin-bottom:14px">Top priorities from MEDDPICC gaps, organized by rep and deal. Check off completed items.</p>`;

  const actionOwners=filterOwner?[filterOwner]:owners.length?owners:['All'];
  actionOwners.forEach(ow=>{
    const owDeals=(filterOwner?filtered:opps.filter(o=>owners.length?o.owner===ow:true)).filter(o=>{
      // Get actions for this deal
      const actions=getActionsForDeal(o);
      return actions.length>0;
    });
    if(!owDeals.length)return;
    const totalActions=owDeals.reduce((s,o)=>s+getActionsForDeal(o).length,0);

    html+=`<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;margin-bottom:12px;overflow:hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--b1);background:var(--s2)">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="width:26px;height:26px;border-radius:50%;background:var(--s3);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bl)">${ow.split(' ').map(w=>w[0]).join('').slice(0,2)}</span>
          <span style="font-size:13px;font-weight:700">${ow}</span>
        </div>
        <span style="font-size:11px;color:var(--t3)">${totalActions} actions across ${owDeals.length} deal${owDeals.length>1?'s':''}</span>
      </div>
      ${owDeals.map((o,di)=>{
        const actions=getActionsForDeal(o);
        const sc=o.scores?._total||{};
        const dealSecId='ai_'+ow.replace(/\s/g,'')+'_'+di;
        const overdue=actions.filter(a=>a.due&&isOverdue(a.due)).length;
        return`<div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--b1)" onclick="document.getElementById('${dealSecId}').classList.toggle('hidden');this.querySelector('.deal-chev').textContent=document.getElementById('${dealSecId}').classList.contains('hidden')?'‚ñ∂':'‚ñº'" onmouseover="this.style.background='var(--s2)'" onmouseout="this.style.background='transparent'">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="deal-chev" style="font-size:9px;color:var(--t3);width:12px">‚ñ∂</span>
              <span style="font-size:12px;font-weight:600;color:var(--acc-t);cursor:pointer" onclick="event.stopPropagation();showDetail('${o.id}')">${o.accountName}</span>
              <span class="badge b-stage" style="font-size:8px">${o.stage}</span>
              ${sc.score?`<span style="font-size:10px;color:var(--t3)">${sc.score}/${sc.max}</span>`:''}
              ${overdue?`<span style="font-size:9px;color:var(--r);font-weight:700">‚ö† ${overdue} overdue</span>`:''}
            </div>
            <span style="font-size:10px;color:var(--t3)">${actions.length} items</span>
          </div>
          <div class="hidden" id="${dealSecId}">
            <table style="border:none;border-radius:0;margin:0"><thead><tr>
              <th style="width:30px;padding:5px 8px"></th>
              <th style="width:90px;padding:5px 8px">Category</th>
              <th style="padding:5px 8px">Action</th>
              <th style="width:90px;padding:5px 8px;text-align:center">Due</th>
            </tr></thead><tbody>
            ${actions.map((a,ai)=>{
              const checkId='act2_'+o.id+'_'+ai;
              const checked=localStorage.getItem(checkId)==='done';
              const od=a.due&&isOverdue(a.due);
              return`<tr style="${checked?'opacity:.4;text-decoration:line-through':''}${od&&!checked?';background:var(--r-bg)':''}" onmouseover="this.style.background=this.style.background||'var(--s2)'" onmouseout="this.style.background='${od&&!checked?'var(--r-bg)':''}'">
                <td style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--b1)"><input type="checkbox" style="accent-color:var(--acc);cursor:pointer" ${checked?'checked':''} onchange="toggleAction2('${checkId}',this)"></td>
                <td style="padding:6px 8px;border-bottom:1px solid var(--b1)"><span style="font-size:9px;font-weight:600;color:var(--t2);text-transform:uppercase">${a.cat}</span></td>
                <td style="padding:6px 8px;font-size:11px;line-height:1.5;border-bottom:1px solid var(--b1)">${a.rec}</td>
                <td style="padding:6px 8px;text-align:center;font-size:10px;border-bottom:1px solid var(--b1);white-space:nowrap;color:${od?'var(--r)':'var(--t3)'};font-weight:${od?'700':'400'}">${a.due||'‚Äî'}</td>
              </tr>`}).join('')}
            </tbody></table>
          </div>
        </div>`}).join('')}
    </div>`;
  });

  html+=`</div>`;

  // ============================================================
  // OPPORTUNITY TABLE ‚Äî grouped by month when quarter selected, else by owner
  // ============================================================
  const renderOppRow=o=>{
    const dtc=Math.ceil((new Date(o.closeDate)-Date.now())/864e5);
    const sc=o.scores?._total||{score:0,max:0,pct:0,status:'at-risk'};
    const dsc=getDaysSinceCall(o);
    const stk=getStakeholderCoverage(o);
    const trend=getScoreTrend(o);
    const trendIcon=trend.dir==='up'?'<span style="color:var(--g)">&#9650;</span>':trend.dir==='down'?'<span style="color:var(--r)">&#9660;</span>':'';
    const callColor=dsc>60?'var(--r)':dsc>30?'var(--y)':'var(--t2)';
    const stkColor=stk.pct<40?'var(--r)':stk.pct<70?'var(--y)':'var(--g)';
    return`<tr onclick="showDetail('${o.id}')">
      <td><div style="font-weight:600;font-size:12px">${o.accountName}</div><div style="font-size:10px;color:var(--t3)">${o.owner}${(o.products||[]).length?' ¬∑ '+(o.products||[]).slice(0,2).join(', '):''}</div></td>
      <td><span class="badge b-stage">${o.stage}</span></td>
      <td style="white-space:nowrap">${o.closeDate}<div style="font-size:10px;color:${dtc<=14?'var(--r)':dtc<=30?'var(--y)':'var(--t3)'}">${dtc}d</div></td>
      <td class="money">${fmtK(o.projectedBilledRevenue||o.revenue?.mcv)}</td>
      <td><div class="sbar"><div class="sbar-f ${barC(sc.status)}" style="width:${sc.pct}%"></div></div><div class="sbar-txt">${sc.score}/${sc.max} ${trendIcon} <span class="badge ${bCls(sc.status)}">${sLbl(sc.status)}</span></div></td>
      <td style="font-size:11px;color:${callColor};white-space:nowrap">${dsc===999?'<span style="color:var(--r);font-weight:700">None</span>':dsc+'d ago'}</td>
      <td style="font-size:11px"><span style="color:${stkColor};font-weight:600">${stk.engaged}/${stk.total}</span> <span style="font-size:9px;color:var(--t3)">engaged</span></td>
      <td style="font-size:10px">${o.merchantIntent||'‚Äî'}</td>
    </tr>`;
  };
  const tableHead=`<thead><tr><th>Account</th><th>Stage</th><th>Close</th><th>PBR</th><th style="width:140px">Health</th><th>Last Call</th><th>Stakeholders</th><th>Intent</th></tr></thead>`;

  if(filterQuarter){
    // GROUP BY MONTH within the selected quarter
    const monthGroups={};
    filtered.forEach(o=>{
      const mk=getMonthKey(o.closeDate);
      if(!monthGroups[mk])monthGroups[mk]=[];
      monthGroups[mk].push(o);
    });
    const sortedMonths=Object.keys(monthGroups).sort();
    sortedMonths.forEach(mk=>{
      const deals=monthGroups[mk].sort((a,b)=>new Date(a.closeDate)-new Date(b.closeDate));
      const monthPbr=deals.reduce((s,o)=>s+(o.projectedBilledRevenue||0),0);
      const monthAtRisk=deals.filter(o=>o.scores?._total?.status==='at-risk').length;
      html+=`<div class="owner-group">
        <div class="owner-header">
          <div class="owner-name">üìÖ ${getMonthLabel(mk)}</div>
          <div class="owner-stats">
            <span>${deals.length} deal${deals.length>1?'s':''}</span>
            <span>Proj Billed Rev: ${fmtK(monthPbr)}</span>
            ${monthAtRisk?`<span style="color:var(--r)">${monthAtRisk} at risk</span>`:''}
          </div>
        </div>
        <table>${tableHead}<tbody>${deals.map(renderOppRow).join('')}</tbody></table>
      </div>`;
    });
  } else {
    // GROUP BY OWNER (default)
    const grouped={};(filterOwner?[filterOwner]:owners.length?owners:['All']).forEach(ow=>{
      grouped[ow]=(filterOwner?filtered:filtered.filter(o=>owners.length?o.owner===ow:true)).sort((a,b)=>{
        const so={'Deal Craft':0,Demonstrate:1,Solution:2,Envision:3,'Pre-Qualified':4};
        return(so[a.stage]||9)-(so[b.stage]||9)||new Date(a.closeDate)-new Date(b.closeDate)});
    });
    Object.entries(grouped).forEach(([owner,deals])=>{
      if(!deals.length)return;
      const ownerPbr=deals.reduce((s,o)=>s+(o.projectedBilledRevenue||0),0);
      html+=`<div class="owner-group"><div class="owner-header"><div class="owner-name">${owner}</div>
        <div class="owner-stats"><span>${deals.length} deals</span><span>Proj Billed Rev: ${fmtK(ownerPbr)}</span></div></div>
        <table>${tableHead}<tbody>${deals.map(renderOppRow).join('')}</tbody></table></div>`;
    });
  }

  el.innerHTML=html;
}
function setFilter(owner){filterOwner=owner;renderList()}
function setQuarter(q){filterQuarter=q;renderList()}
function setStage(s){filterStage=s;renderList()}
function setHealth(h){filterHealth=h===filterHealth?null:h;renderList()}
function clearAllFilters(){filterOwner=null;filterQuarter=null;filterStage=null;filterHealth=null;renderList()}

// ============================================================
// DETAIL VIEW
// ============================================================
function showDetail(id){
  const opp=opps.find(o=>o.id===id);if(!opp)return;currentOpp=opp;
  document.getElementById('v-list').classList.add('hidden');
  const el=document.getElementById('v-detail');el.classList.remove('hidden');
  const s=opp.scores||{_total:{score:0,max:0,pct:0,status:'at-risk'}};
  const secs=Object.values(opp.meddpicc||{});
  const ns=opp.nextSteps||[];
  const hist=opp.history||[];
  const dtc=Math.ceil((new Date(opp.closeDate)-Date.now())/864e5);
  const cmts=getComments(opp.id);
  const hasMeddpicc=secs.length>0;
  const pbr=opp.projectedBilledRevenue;
  const prods=opp.products||[];

  // Build tabs
  const tabNames=['Overview'];
  if(hasMeddpicc)tabNames.push('MEDDPICC');
  tabNames.push('MAP','Next Steps','Stakeholders');
  if((opp.stakeholders||[]).length)tabNames.push('Org Chart');
  tabNames.push('Calls','History','Comments');

  el.innerHTML=`<button class="back" onclick="goBack()">‚Üê Pipeline</button>
  <div class="dh-top"><div>
    <h1>${opp.accountName}</h1>
    <div class="dh-meta">
      <span class="chip">üìã ${opp.stage}</span>
      <span class="chip">üìÖ ${opp.closeDate} (${dtc}d)</span>
      <span class="chip">üí∞ ${fmtK(pbr||opp.revenue?.mcv)} PBR</span>
      <span class="chip">üéØ ${opp.forecastCategory||''} ¬∑ ${opp.probability}%</span>
      <span class="chip">üë§ ${opp.owner}</span>
      ${opp.competitor?`<span class="chip">‚öîÔ∏è ${opp.competitor}</span>`:''}
    </div>
  </div>
  ${hasMeddpicc?`<div class="big-score"><div class="num" style="color:var(--${barC(s._total.status)==='risk'?'r':barC(s._total.status)==='track'?'y':'g'})">${s._total.score}</div><div class="of">/ ${s._total.max}</div><span class="badge ${bCls(s._total.status)}">${sLbl(s._total.status)}</span></div>`:''}</div>

  <!-- Products strip -->
  ${prods.length?`<div class="prod-strip">${prods.map(p=>`<div class="prod-pill"><span class="pi">üì¶</span>${p}</div>`).join('')}</div>`:''}

  ${hasMeddpicc?`<div class="tiles">${secs.map(sec=>{const sc=s[sec.label]||{score:0,max:0,pct:0};return`<div class="tile ${tCls(sc.pct)}"><div class="tl">${sec.label}</div><div class="tv">${sc.score}</div><div class="tm">/ ${sc.max}</div></div>`}).join('')}</div>`:''}

  <!-- Revenue Summary -->
  <div class="rev-card">
    <h3 style="font-size:14px;font-weight:700;margin-bottom:8px">üìä Revenue</h3>
    <div class="rev-grid">
      ${pbr?`<div class="rev-item"><div class="rl">Proj Billed Rev</div><div class="rv" style="color:var(--g);font-weight:700">${fmtK(pbr)}</div></div>`:``}
      <div class="rev-item"><div class="rl">Total Rev (3yr)</div><div class="rv">${fmtK(opp.revenue?.totalRev3yr)}</div></div>
      <div class="rev-item"><div class="rl">MCV</div><div class="rv">${fmtK(opp.revenue?.mcv)}</div></div>
      <div class="rev-item"><div class="rl">D2C GMV</div><div class="rv">${fmtK(opp.revenue?.d2cGmv)}</div></div>
      ${opp.revenue?.b2bGmv?`<div class="rev-item"><div class="rl">B2B GMV</div><div class="rv">${fmtK(opp.revenue.b2bGmv)}</div></div>`:''}
      ${opp.revenue?.retailGmv?`<div class="rev-item"><div class="rl">Retail GMV</div><div class="rv">${fmtK(opp.revenue.retailGmv)}</div></div>`:''}
      <div class="rev-item"><div class="rl">Payments GPV</div><div class="rv" style="color:var(--bl)">${fmtK(opp.revenue?.paymentsGpv)}</div></div>
    </div>
  </div>

  <div class="tabs">${tabNames.map((t,i)=>`<button class="tab${i===0?' on':''}" data-p="${t.toLowerCase().replace(/\s/g,'')}">${t}${t==='Comments'?' ('+cmts.length+')':''}</button>`).join('')}</div>

  <!-- OVERVIEW -->
  <div class="pane on" id="p-overview">
    ${(opp.dealRisks&&opp.dealRisks.length)?`<div class="risks-panel" style="margin-bottom:16px">
      <h3 style="font-size:14px;font-weight:700;margin-bottom:10px">‚ö†Ô∏è Deal Risks</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${opp.dealRisks.map(r=>{
          const sev=r.severity||'medium';
          const icon=sev==='high'?'üî¥':sev==='medium'?'üü°':'üü¢';
          const bg=sev==='high'?'rgba(255,59,48,0.08)':sev==='medium'?'rgba(255,204,0,0.08)':'rgba(52,199,89,0.08)';
          const border=sev==='high'?'rgba(255,59,48,0.25)':sev==='medium'?'rgba(255,204,0,0.25)':'rgba(52,199,89,0.25)';
          return`<div style="padding:10px 14px;border-radius:8px;background:${bg};border:1px solid ${border};font-size:13px;line-height:1.5">
            <span style="margin-right:6px">${icon}</span>
            <span style="font-weight:600;text-transform:uppercase;font-size:11px;letter-spacing:0.5px;margin-right:8px;opacity:0.7">${r.category||''}</span>
            ${r.risk}
          </div>`}).join('')}
      </div>
    </div>`:''}
    <div class="nar-grid">
      ${renderNarrative(opp,'narrative.oppSummary','üìù Opportunity Summary',true)}
      ${renderNarrative(opp,'narrative.whyChange','üîÑ Why Change?')}
      ${renderNarrative(opp,'narrative.whyShopify','üíö Why Shopify?')}
      ${renderNarrative(opp,'narrative.whyNow','‚è∞ Why Now?')}
      ${renderNarrative(opp,'narrative.supportNeeded','ü§ù Support Needed')}
    </div>
    ${opp.dealUndercurrent?renderDealUndercurrent(opp.dealUndercurrent):''}
    ${opp.compellingEvent?`${renderNarrative(opp,'compellingEvent','‚ö° Compelling Event',false,true)}`:''}
    ${opp.nextStep?`${renderNarrative(opp,'nextStep','üìå AE Next Step',false,true)}`:''}
  </div>

  <!-- MEDDPICC -->
  ${hasMeddpicc?`<div class="pane" id="p-meddpicc">${Object.entries(opp.meddpicc).map(([k,sec],i)=>{
    const sc=s[sec.label]||{score:0,max:0,pct:0};
    return`<div class="msec${i===0?' open':''}"><div class="msec-h" onclick="this.parentElement.classList.toggle('open')">
      <div class="msec-t"><span class="chev">‚ñ∂</span>${sec.label} <span class="badge ${sc.pct<50?'b-risk':sc.pct<75?'b-track':'b-good'}">${sc.score}/${sc.max}</span></div>
      <div class="msec-s">${sc.pct}%</div></div>
      <div class="msec-b"><div class="mhdr"><div>Question</div><div style="text-align:center">Status</div><div>Notes</div><div>Solution</div><div>Action</div><div style="text-align:center">Due</div></div>
      ${sec.questions.map((q,qi)=>{
        const rowId='mrow_'+k+'_'+qi;
        return`<div class="mrow" id="${rowId}" ondblclick="editMeddpiccRow('${opp.id}','${k}',${qi})">
        <div class="q">${q.q}</div>
        <div class="ac ${aCls(q.answer)}">${q.answer||'‚Äî'}</div>
        <div class="nt">${q.notes||''}</div>
        <div class="nt">${q.solution||''}</div>
        <div class="nt">${q.action||''}</div>
        <div class="du">${q.due||''}</div>
      </div>`}).join('')}</div></div>`}).join('')}
      <p style="color:var(--t3);font-size:11px;margin-top:6px;font-style:italic">üí° Double-click any row to edit</p>
      </div>`:''}

  <!-- MUTUAL ACTION PLAN -->
  <div class="pane" id="p-map">
    ${renderMAP(opp)}
  </div>

  <!-- NEXT STEPS -->
  <div class="pane" id="p-nextsteps">
    <p style="color:var(--t3);font-size:12px;margin-bottom:14px">Auto-generated from MEDDPICC gaps, timeline, and stakeholder engagement.</p>
    ${ns.length?ns.map(n=>`<div class="ns ${n.p}"><div class="ns-top"><span class="ns-cat">${n.p} ¬∑ ${n.cat}</span><span class="ns-due">${n.due||''}</span></div><div class="ns-issue">${n.issue}</div><div class="ns-rec">üí° ${n.rec}</div></div>`).join(''):'<p style="color:var(--t3);font-size:12px">No action items generated.</p>'}
  </div>

  <!-- STAKEHOLDERS -->
  <div class="pane" id="p-stakeholders">
    ${(opp.stakeholders||[]).length?`
    <h3 style="font-size:14px;margin-bottom:14px">Stakeholder Engagement Map</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px">
      ${opp.stakeholders.map(s=>{
        const eng=s.engagement||'none';
        const engC=eng==='high'?'g':eng==='medium'?'y':eng==='low'?'r':'t3';
        const engBg=eng==='high'?'g-bg':eng==='medium'?'y-bg':eng==='low'?'r-bg':'s2';
        const engBd=eng==='high'?'g-b':eng==='medium'?'y-b':eng==='low'?'r-b':'b1';
        const engLabel=eng==='high'?'High':eng==='medium'?'Med':eng==='low'?'Low':'None';
        const callPct=s.callsInvited>0?Math.round(s.callsAttended/s.callsInvited*100):0;
        const isGap=(eng==='low'||eng==='none')&&(s.role==='Decision Maker'||s.role==='Economic Buyer'||s.role==='Signatory');
        return`<div style="background:var(--s1);border:1px solid var(--${engBd});border-radius:10px;padding:12px 14px;${isGap?'border-left:3px solid var(--r)':'border-left:3px solid var(--'+engC+')'}">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
            <div class="av" style="width:32px;height:32px;font-size:11px">${ini(s.name)}</div>
            <span style="font-size:8px;font-weight:700;color:var(--${engC});background:var(--${engBg});padding:2px 6px;border-radius:3px;border:1px solid var(--${engBd})">${engLabel}</span>
          </div>
          <div style="font-size:12px;font-weight:600;margin-bottom:2px">${s.name}</div>
          <div style="font-size:10px;color:var(--t2);margin-bottom:4px">${s.title||''}</div>
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
            <span class="badge b-stage" style="font-size:8px">${s.role||'Contact'}</span>
          </div>
          ${s.callsInvited>0?`<div style="margin-top:4px">
            <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--t3);margin-bottom:2px"><span>Calls</span><span>${s.callsAttended}/${s.callsInvited}</span></div>
            <div style="height:4px;background:var(--s3);border-radius:2px;overflow:hidden"><div style="width:${callPct}%;height:100%;background:var(--${callPct>=60?'g':callPct>=30?'y':'r'});border-radius:2px"></div></div>
          </div>`:'<div style="font-size:9px;color:var(--t3);margin-top:4px">No calls tracked</div>'}
          ${isGap?'<div style="font-size:9px;color:var(--r);font-weight:700;margin-top:6px">‚ö† Key stakeholder ‚Äî low engagement</div>':''}
        </div>`}).join('')}
    </div>
    ${(()=>{
      const gaps=(opp.stakeholders||[]).filter(s=>(s.engagement==='low'||s.engagement==='none')&&(s.role==='Decision Maker'||s.role==='Economic Buyer'||s.role==='Signatory'));
      const strong=(opp.stakeholders||[]).filter(s=>s.engagement==='high');
      if(!gaps.length)return'';
      return'<div style="background:var(--r-bg);border:1px solid var(--r-b);border-radius:8px;padding:12px 14px;margin-bottom:16px"><div style="font-size:11px;font-weight:700;color:var(--r);margin-bottom:4px">\u26A0 Engagement Gap</div><div style="font-size:12px;color:var(--t);line-height:1.6">'+gaps.map(g=>'<b>'+g.name+'</b> ('+g.role+')').join(', ')+' ‚Äî key decision maker'+(gaps.length>1?'s':'')+' with low/no engagement.'+(strong.length?' Leverage <b>'+strong[0].name+'</b> to get access.':'')+'</div></div>';
    })()}`:''}
    ${(opp.shopifyTeam||[]).length?`<h3 style="font-size:14px;margin-bottom:10px">Shopify Team</h3><div class="sg">${opp.shopifyTeam.map(s=>`<div class="sc"><div class="av blue">${ini(s.name)}</div><div class="si"><div class="sn">${s.name}</div><div class="st">${s.role||''}</div></div></div>`).join('')}</div>`:''}
  </div>

  <!-- ORG CHART -->
  ${(opp.stakeholders||[]).length?`<div class="pane" id="p-orgchart">
    <div class="org-toolbar">
      <h3>üè¢ Organization Chart</h3>
      <div class="org-toolbar-actions">
        <button class="org-btn" onclick="resetOrgChart('${opp.id}')">‚Ü∫ Reset Layout</button>
      </div>
    </div>
    <div class="org-legend">
      <div class="org-legend-item"><div class="org-legend-dot" style="background:var(--r)"></div> Decision Maker</div>
      <div class="org-legend-item"><div class="org-legend-dot" style="background:var(--y)"></div> Evaluator</div>
      <div class="org-legend-item"><div class="org-legend-dot" style="background:var(--g)"></div> Influencer</div>
      <div class="org-legend-item"><div class="org-legend-dot" style="background:var(--bl)"></div> Champion</div>
      <div class="org-legend-item"><div class="org-legend-dot" style="background:var(--t3)"></div> Contact</div>
      <div style="flex:1"></div>
      <div class="org-legend-item" style="color:var(--t2)">üí° Drag & drop people to rearrange the hierarchy</div>
    </div>
    <div class="org-chart-container" id="orgchart-${opp.id}"></div>
  </div>`:''}

  <!-- CALLS -->
  <div class="pane" id="p-calls">
    ${(opp.calls||[]).length?opp.calls.map(c=>`<div class="cc"><div class="cc-top"><div class="cc-title">üìû ${c.title}</div><div class="cc-date">${c.date} ¬∑ ${c.duration}</div></div><div class="cc-att"><b>Shopify:</b> ${c.shopifyAttendees.join(', ')} | <b>Merchant:</b> ${c.merchantAttendees.join(', ')}</div><div class="cc-sum">${c.summary}</div></div>`).join(''):'<p style="color:var(--t3);font-size:12px">No calls recorded.</p>'}
  </div>

  <!-- VERSION HISTORY -->
  <div class="pane" id="p-history">
    <p style="color:var(--t3);font-size:12px;margin-bottom:14px">Track how this deal's health has changed over time. Click an entry to see details.</p>
    ${hist.length?hist.slice().reverse().map((h,idx)=>{
      const prev=hist[hist.indexOf(h)-1];
      const scoreDelta=prev?(h.totalScore-prev.totalScore):0;
      const deltaStr=scoreDelta>0?'+'+scoreDelta:scoreDelta<0?''+scoreDelta:'0';
      const deltaClass=scoreDelta>0?'up':scoreDelta<0?'down':'neutral';
      const typeLabel=h.type==='lite-refresh'?'‚ö° Lite Refresh':h.type==='full'?'üîÑ Full Analysis':'üìä Snapshot';
      const hasChanges=h.changes&&h.changes.length>0;
      const entryId='vh_entry_'+idx;
      // Categorize changes
      const scoreChanges=(h.changes||[]).filter(c=>typeof c==='string'&&(c.includes('‚Üí')&&(c.includes(' Q'))||c.startsWith('Score ')));
      const sfTriggers=(h.changes||[]).filter(c=>typeof c==='string'&&c.startsWith('SF trigger:'));
      // Section score diffs
      const sectionDiffs=prev?Object.entries(h.sectionScores||{}).filter(([k,v])=>prev.sectionScores&&prev.sectionScores[k]!=null&&prev.sectionScores[k]!==v).map(([k,v])=>({section:k,old:prev.sectionScores[k],new:v,delta:v-prev.sectionScores[k]})):[];
      return`<div class="vh ${hasChanges?'clickable':''}" ${hasChanges?`onclick="document.getElementById('${entryId}').classList.toggle('hidden')"`:''}  style="${hasChanges?'cursor:pointer':''}">
        <div class="vh-date">
          üìÖ ${h.date}
          <span class="badge ${bCls(h.status)}" style="font-size:9px">${sLbl(h.status)}</span>
          <span style="font-size:10px;color:var(--t3)">${typeLabel}</span>
          ${scoreDelta!==0?`<span class="vh-delta ${deltaClass}">${deltaStr}</span>`:''}
        </div>
        <div class="vh-score">Score: <b>${h.totalScore}</b>/${h.totalMax}${prev?' (prev: '+prev.totalScore+')':' (baseline)'}${sectionDiffs.length?' ¬∑ '+sectionDiffs.map(d=>`<span style="color:var(--${d.delta>0?'g':'r'})">${d.section} ${d.delta>0?'+':''}${d.delta}</span>`).join(' '):''}</div>
        ${hasChanges?`<div style="font-size:10px;color:var(--acc-t);margin-top:4px">‚ñ∂ ${h.changes.length} change${h.changes.length>1?'s':''} ‚Äî click to expand</div>
        <div class="hidden" id="${entryId}" style="margin-top:10px;border-top:1px solid var(--b1);padding-top:10px">
          ${scoreChanges.length?`<div style="margin-bottom:10px">
            <div style="font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìä Score Adjustments</div>
            ${scoreChanges.map(c=>{
              const isUp=c.includes('improved')||c.includes('+');
              const isDown=c.includes('declined')||c.includes('(-');
              return`<div style="font-size:12px;color:var(--t);padding:4px 0;display:flex;align-items:flex-start;gap:6px">
                <span style="flex-shrink:0;font-size:14px">${isDown?'üîª':isUp?'üî∫':'‚Ä¢'}</span>
                <span>${c}</span>
              </div>`}).join('')}
          </div>`:''}
          ${sfTriggers.length?`<div style="margin-bottom:10px">
            <div style="font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üîó Salesforce Triggers</div>
            ${sfTriggers.map(c=>`<div style="font-size:11px;color:var(--t2);padding:3px 0;display:flex;align-items:center;gap:6px">
              <span style="flex-shrink:0">‚Ü≥</span><span>${c.replace('SF trigger: ','')}</span>
            </div>`).join('')}
          </div>`:''}
          ${sectionDiffs.length?`<div>
            <div style="font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìà Section Score Changes</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px">
              ${sectionDiffs.map(d=>`<div style="background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:8px 10px;text-align:center;border-left:3px solid var(--${d.delta>0?'g':'r'})">
                <div style="font-size:10px;color:var(--t3)">${d.section}</div>
                <div style="font-size:16px;font-weight:800;color:var(--${d.delta>0?'g':'r'})">${d.old} ‚Üí ${d.new}</div>
                <div style="font-size:10px;color:var(--${d.delta>0?'g':'r'})">${d.delta>0?'+':''}${d.delta}</div>
              </div>`).join('')}
            </div>
          </div>`:''}
        </div>`:`<div style="font-size:11px;color:var(--t3);margin-top:4px">No changes from previous snapshot.</div>`}
      </div>`}).join(''):'<p style="color:var(--t3);font-size:12px">No version history yet.</p>'}
  </div>

  <!-- COMMENTS -->
  <div class="pane" id="p-comments"><div class="cmt-section" id="cmt-sec"></div></div>`;

  // Tab switching
  el.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    el.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    el.querySelectorAll('.pane').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');document.getElementById('p-'+t.dataset.p).classList.add('on');
  }));
  renderComments();if((opp.stakeholders||[]).length)renderOrgChart(opp);window.scrollTo(0,0);history.replaceState(null,null,'#'+id);
}

// ============================================================
// DEAL UNDERCURRENT
// ============================================================
function renderDealUndercurrent(uc){
  const sevColors={high:'#ff4d4f',medium:'#faad14',low:'#52c41a'};
  const sevBg={high:'rgba(255,77,79,0.08)',medium:'rgba(250,173,20,0.08)',low:'rgba(82,196,26,0.08)'};
  const sevBorder={high:'rgba(255,77,79,0.25)',medium:'rgba(250,173,20,0.25)',low:'rgba(82,196,26,0.25)'};
  const sevLabel={high:'HIGH',medium:'MEDIUM',low:'LOW'};
  return`<div style="margin:20px 0 16px 0;border:1px solid var(--b1);border-radius:12px;overflow:hidden;background:var(--s1)">
    <div style="padding:14px 18px;background:linear-gradient(135deg,rgba(120,80,220,0.12),rgba(200,100,180,0.08));border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:20px">üîÆ</span>
        <span style="font-size:15px;font-weight:800;letter-spacing:-0.3px">Deal Undercurrent</span>
        <span style="font-size:10px;background:rgba(120,80,220,0.15);color:rgba(180,140,255,1);padding:2px 8px;border-radius:10px;font-weight:600;letter-spacing:0.3px">FROM ${uc.sourceCallCount} CALLS ¬∑ ${uc.sourceTranscriptLines.toLocaleString()} TRANSCRIPT LINES</span>
      </div>
      <span style="font-size:11px;color:var(--t3)">Updated ${uc.lastUpdated}</span>
    </div>
    <div style="padding:14px 18px 8px 18px">
      <div style="font-size:12px;color:var(--t3);margin-bottom:12px;line-height:1.5;font-style:italic">${uc.surfaceStory}</div>
      ${uc.sections.map(s=>`<div style="margin-bottom:10px;padding:12px 14px;border-radius:8px;background:${sevBg[s.severity]};border:1px solid ${sevBorder[s.severity]}">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <span style="font-size:13px;font-weight:700">${s.title}</span>
          <span style="font-size:9px;font-weight:700;color:${sevColors[s.severity]};background:${sevBg[s.severity]};border:1px solid ${sevBorder[s.severity]};padding:1px 6px;border-radius:4px;letter-spacing:0.5px">${sevLabel[s.severity]}</span>
        </div>
        <div style="font-size:12px;line-height:1.6;color:var(--t2)">${s.content}</div>
      </div>`).join('')}
      <div style="margin-top:14px;padding:14px;border-radius:8px;background:rgba(120,80,220,0.06);border:1px solid rgba(120,80,220,0.2)">
        <div style="font-size:12px;font-weight:700;color:rgba(180,140,255,1);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">‚ö° Net Assessment</div>
        <div style="font-size:12px;line-height:1.7;color:var(--t2)">${uc.netAssessment}</div>
      </div>
    </div>
  </div>`;
}

// EDITABLE NARRATIVES
// ============================================================
function renderNarrative(opp,path,title,fullWidth,standalone){
  const val=getEditedValue(opp,path);
  if(!val&&!standalone)return'';
  const cls=fullWidth?'nar fw':standalone?'nar':'nar';
  const style=standalone?'style="margin-bottom:12px"':'';
  const uid=path.replace(/\./g,'_');
  return`<div class="${cls}" ${style} id="nar_${uid}">
    <h3>${title} <button class="edit-btn" onclick="startNarEdit('${opp.id}','${path}','${uid}')">‚úèÔ∏è Edit</button></h3>
    <p id="nar_p_${uid}">${(val||'').replace(/\n/g,'<br>')}</p>
  </div>`;
}

function startNarEdit(oppId,path,uid){
  const pEl=document.getElementById('nar_p_'+uid);
  const current=getEditedValue(currentOpp,path);
  pEl.innerHTML=`<textarea id="nar_ta_${uid}" rows="6">${current}</textarea>
    <div class="save-row"><button class="save-btn" onclick="saveNarEdit('${oppId}','${path}','${uid}')">Save</button>
    <button class="cancel-btn" onclick="showDetail('${oppId}')">Cancel</button></div>`;
  document.getElementById('nar_ta_'+uid).focus();
}

function saveNarEdit(oppId,path,uid){
  const ta=document.getElementById('nar_ta_'+uid);
  if(!ta)return;
  const val=ta.value;
  saveEdit(oppId,path,val);
  // Also update the live data object for this session
  const parts=path.split('.');
  let obj=currentOpp;
  for(let i=0;i<parts.length-1;i++){if(!obj[parts[i]])obj[parts[i]]={};obj=obj[parts[i]]}
  obj[parts[parts.length-1]]=val;
  showDetail(oppId);
}

// ============================================================
// EDITABLE MEDDPICC ROWS
// ============================================================
function editMeddpiccRow(oppId,secKey,qIdx){
  const opp=opps.find(o=>o.id===oppId);if(!opp)return;
  const q=opp.meddpicc[secKey].questions[qIdx];
  const rowId='mrow_'+secKey+'_'+qIdx;
  const rowEl=document.getElementById(rowId);if(!rowEl)return;
  rowEl.ondblclick=null;
  rowEl.innerHTML=`
    <div class="q">${q.q}</div>
    <div class="mrow-edit" style="text-align:center"><select id="me_ans_${rowId}">
      <option value="Yes" ${q.answer==='Yes'?'selected':''}>Yes</option>
      <option value="Partial" ${q.answer==='Partial'?'selected':''}>Partial</option>
      <option value="No" ${q.answer==='No'?'selected':''}>No</option>
    </select></div>
    <div class="mrow-edit"><textarea id="me_notes_${rowId}">${q.notes||''}</textarea></div>
    <div class="mrow-edit"><textarea id="me_sol_${rowId}">${q.solution||''}</textarea></div>
    <div class="mrow-edit"><textarea id="me_act_${rowId}">${q.action||''}</textarea></div>
    <div class="mrow-edit"><input type="text" id="me_due_${rowId}" value="${q.due||''}" style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid var(--inp-b);background:var(--inp-bg);color:var(--t);font-size:11px;outline:none;text-align:center" placeholder="MM/DD/YYYY"></div>`;
  // Add save/cancel buttons below the row
  const actionsDiv=document.createElement('div');
  actionsDiv.className='mrow-actions';
  actionsDiv.innerHTML=`<button class="save-btn" onclick="saveMeddpiccRow('${oppId}','${secKey}',${qIdx})">Save</button>
    <button class="cancel-btn" onclick="showDetail('${oppId}')">Cancel</button>`;
  rowEl.parentElement.insertBefore(actionsDiv,rowEl.nextSibling);
}

function saveMeddpiccRow(oppId,secKey,qIdx){
  const rowId='mrow_'+secKey+'_'+qIdx;
  const opp=opps.find(o=>o.id===oppId);if(!opp)return;
  const q=opp.meddpicc[secKey].questions[qIdx];
  q.answer=document.getElementById('me_ans_'+rowId).value;
  q.notes=document.getElementById('me_notes_'+rowId).value;
  q.solution=document.getElementById('me_sol_'+rowId).value;
  q.action=document.getElementById('me_act_'+rowId).value;
  q.due=document.getElementById('me_due_'+rowId).value;
  q.score=q.answer==='Yes'?1:q.answer==='Partial'?0.5:0;
  // Recalculate scores
  recalcScores(opp);
  // Save all edits to localStorage
  const key='meddpicc_'+secKey+'_'+qIdx;
  saveEdit(oppId,key,{answer:q.answer,notes:q.notes,solution:q.solution,action:q.action,due:q.due});
  showDetail(oppId);
}

function recalcScores(opp){
  const scores={};let totalScore=0,totalMax=0;
  Object.entries(opp.meddpicc).forEach(([k,sec])=>{
    const score=sec.questions.reduce((s,q)=>s+(q.score||0),0);
    const max=sec.questions.length;
    scores[sec.label]={score,max,pct:Math.round(score/max*100)};
    totalScore+=score;totalMax+=max;
  });
  const pct=Math.round(totalScore/totalMax*100);
  scores._total={score:totalScore,max:totalMax,pct,status:pct<50?'at-risk':pct<75?'on-track':'good-health'};
  opp.scores=scores;
}

// ============================================================
// COMMENTS UI
// ============================================================
function renderComments(){
  const el=document.getElementById('cmt-sec');if(!el||!currentOpp)return;
  const cmts=getComments(currentOpp.id);
  const user=localStorage.getItem('cmt_user')||'';
  el.innerHTML=`<h3>üí¨ Comments (${cmts.length})</h3>
  ${!user?`<div style="margin-bottom:12px"><input class="cmt-inp" id="cmt-name" placeholder="Your name (saved for future)" style="margin-bottom:6px;width:100%"><button class="filter-btn" onclick="saveName()">Set Name</button></div>`:''}
  ${user?`<div class="cmt-row"><input class="cmt-inp" id="ci" placeholder="Add a comment‚Ä¶" onkeydown="if(event.key==='Enter')postComment()"><button onclick="postComment()">Post</button></div>`:''}
  ${cmts.slice().reverse().map(c=>`<div class="cmt"><div class="cmt-top"><span class="cmt-author">${c.author}</span><span class="cmt-time">${ago(c.ts)} ago<span class="cmt-del" onclick="delComment('${c.id}')">‚úï</span></span></div><div class="cmt-text">${c.text}</div></div>`).join('')}
  ${!cmts.length?'<p style="color:var(--t3);font-size:12px">No comments yet.</p>':''}`;
}
function saveName(){const n=document.getElementById('cmt-name').value.trim();if(n){localStorage.setItem('cmt_user',n);renderComments()}}
async function postComment(){const i=document.getElementById('ci'),t=i.value.trim();if(!t)return;await addComment(currentOpp.id,t,localStorage.getItem('cmt_user')||'Anonymous');renderComments()}
async function delComment(id){await deleteComment(currentOpp.id,id);renderComments()}

// ============================================================
// MUTUAL ACTION PLAN RENDERER
// ============================================================
// ============================================================
// MAP ‚Äî fully editable mutual action plan
// All edits persist to localStorage keyed by opp ID.
// ============================================================
function getMapItems(opp){
  const key='map_items_'+opp.id;
  const saved=localStorage.getItem(key);
  if(saved){try{return JSON.parse(saved)}catch(e){}}
  // Fall back to data.js defaults
  return(opp.mutualActionPlan&&opp.mutualActionPlan.items||[]).map(i=>({...i}));
}
function saveMapItems(oppId,items){localStorage.setItem('map_items_'+oppId,JSON.stringify(items));toast('‚úì MAP saved')}
function getMapMeta(opp){
  const key='map_meta_'+opp.id;
  const saved=localStorage.getItem(key);
  if(saved){try{return JSON.parse(saved)}catch(e){}}
  const m=opp.mutualActionPlan||{};
  return{kickoffDate:m.kickoffDate||'',goLiveDate:m.goLiveDate||'',contactName:m.contactName||'',contactEmail:m.contactEmail||'',champion:m.champion||''};
}
function saveMapMeta(oppId,meta){localStorage.setItem('map_meta_'+oppId,JSON.stringify(meta));toast('‚úì MAP saved')}

function renderMAP(opp){
  const items=getMapItems(opp);
  const meta=getMapMeta(opp);
  const done=items.filter(i=>i.done).length;
  const total=items.length;
  const pct=total?Math.round(done/total*100):0;
  const pctColor=pct<30?'r':pct<60?'y':'g';
  return`
  <div class="map-hdr">
    <h3>üìã ${opp.accountName} ‚Äî Mutual Action Plan</h3>
    <div class="map-progress">
      <div class="mp-bar"><div class="mp-fill" id="map-fill" style="width:${pct}%;background:var(--${pctColor})"></div></div>
      <span id="map-pct" style="font-size:12px;font-weight:700;color:var(--${pctColor})">${done}/${total} (${pct}%)</span>
    </div>
  </div>
  <div class="map-info" style="border-radius:0">
    <div class="map-info-item"><div class="map-info-label">Project Kick Off</div><div contenteditable style="font-weight:600;outline:none;border-bottom:1px dashed var(--b1);min-width:80px" onblur="mapMetaEdit('${opp.id}','kickoffDate',this.textContent)">${meta.kickoffDate||'TBD'}</div></div>
    <div class="map-info-item"><div class="map-info-label">Go Live Date</div><div contenteditable style="font-weight:700;color:var(--acc-t);outline:none;border-bottom:1px dashed var(--b1)" onblur="mapMetaEdit('${opp.id}','goLiveDate',this.textContent)">${meta.goLiveDate||'TBD'}</div></div>
    <div class="map-info-item"><div class="map-info-label">Questions?</div><div>Contact <span contenteditable style="outline:none;border-bottom:1px dashed var(--b1)" onblur="mapMetaEdit('${opp.id}','contactName',this.textContent)">${meta.contactName||'TBD'}</span></div><div contenteditable style="font-size:10px;color:var(--bl);outline:none;border-bottom:1px dashed var(--b1)" onblur="mapMetaEdit('${opp.id}','contactEmail',this.textContent)">${meta.contactEmail||''}</div></div>
    <div class="map-info-item"><div class="map-info-label">Merchant Champion</div><div contenteditable style="font-weight:600;outline:none;border-bottom:1px dashed var(--b1)" onblur="mapMetaEdit('${opp.id}','champion',this.textContent)">${meta.champion||'TBD'}</div></div>
  </div>
  <table class="map-tbl" style="border-radius:0 0 10px 10px;border-top:none">
    <thead><tr>
      <th style="width:100px">Target Date</th>
      <th style="width:40px;text-align:center">‚úì</th>
      <th>Milestone</th>
      <th style="width:140px">Owner (${opp.accountName.split(' ')[0]})</th>
      <th style="width:140px">Owner (Shopify)</th>
      <th>Outcome / Notes</th>
      <th style="width:30px"></th>
    </tr></thead>
    <tbody id="map-tbody">
    ${items.map((item,idx)=>{
      return mapRowHtml(opp.id,item,idx,items.length)}).join('')}
    </tbody>
  </table>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button style="padding:6px 14px;border-radius:6px;background:var(--acc);color:#fff;border:none;font-size:11px;font-weight:600;cursor:pointer" onclick="mapAddRow('${opp.id}')">+ Add milestone</button>
    <button style="padding:6px 14px;border-radius:6px;background:var(--s3);color:var(--t2);border:1px solid var(--b1);font-size:11px;cursor:pointer" onclick="mapAddSection('${opp.id}')">+ Add section header</button>
    <button style="padding:6px 14px;border-radius:6px;background:var(--s3);color:var(--t2);border:1px solid var(--b1);font-size:11px;cursor:pointer;margin-left:auto" onclick="if(confirm('Reset MAP to auto-generated defaults?')){localStorage.removeItem('map_items_'+currentOpp.id);localStorage.removeItem('map_meta_'+currentOpp.id);showDetail(currentOpp.id)}">‚Ü∫ Reset to default</button>
  </div>
  <p style="color:var(--t3);font-size:10px;margin-top:8px;font-style:italic">üí° Click any cell to edit. Drag ‚â° to reorder. All changes save automatically.</p>`;
}
function mapRowHtml(oppId,item,idx,total){
  const isDone=item.done;
  const isSection=item.isSection;
  if(isSection){
    return`<tr style="background:var(--s2)">
      <td colspan="6" contenteditable style="font-size:11px;font-weight:700;color:var(--acc-t);text-transform:uppercase;letter-spacing:.5px;outline:none;padding:6px 12px" onblur="mapCellEdit('${oppId}',${idx},'milestone',this.textContent)">${item.milestone||'Section'}</td>
      <td style="text-align:center;padding:4px"><span style="cursor:pointer;font-size:12px;color:var(--t3)" onclick="mapDeleteRow('${oppId}',${idx})" title="Delete section">‚úï</span></td>
    </tr>`;
  }
  return`<tr class="${isDone?'map-done':''}" draggable="true" ondragstart="mapDragStart(event,${idx})" ondragover="event.preventDefault()" ondrop="mapDrop(event,'${oppId}',${idx})" style="transition:background .1s">
    <td contenteditable style="white-space:nowrap;font-size:10px;color:var(--t3);outline:none;min-width:80px;border-bottom:1px solid var(--b1)" onblur="mapCellEdit('${oppId}',${idx},'date',this.textContent)">${item.date||''}</td>
    <td style="text-align:center;border-bottom:1px solid var(--b1)"><input type="checkbox" class="map-check" ${isDone?'checked':''} onchange="mapToggle('${oppId}',${idx},this)"></td>
    <td contenteditable style="outline:none;border-bottom:1px solid var(--b1)" onblur="mapCellEdit('${oppId}',${idx},'milestone',this.textContent)">${item.milestone||''}</td>
    <td contenteditable style="font-size:10px;color:var(--t2);outline:none;border-bottom:1px solid var(--b1)" onblur="mapCellEdit('${oppId}',${idx},'ownerMerchant',this.textContent)">${item.ownerMerchant||''}</td>
    <td contenteditable style="font-size:10px;color:var(--bl);outline:none;border-bottom:1px solid var(--b1)" onblur="mapCellEdit('${oppId}',${idx},'ownerShopify',this.textContent)">${item.ownerShopify||''}</td>
    <td contenteditable style="font-size:10px;color:var(--t2);outline:none;border-bottom:1px solid var(--b1)" onblur="mapCellEdit('${oppId}',${idx},'notes',this.textContent)">${item.notes||''}</td>
    <td style="text-align:center;padding:4px;border-bottom:1px solid var(--b1)"><span style="cursor:grab;font-size:12px;color:var(--t3);user-select:none" title="Drag to reorder">‚â°</span><br><span style="cursor:pointer;font-size:10px;color:var(--t3)" onclick="mapDeleteRow('${oppId}',${idx})" title="Delete">‚úï</span></td>
  </tr>`;
}
function mapCellEdit(oppId,idx,field,value){
  const items=getMapItems(opps.find(o=>o.id===oppId));
  if(!items[idx])return;
  items[idx][field]=value.trim();
  saveMapItems(oppId,items);
}
function mapToggle(oppId,idx,el){
  const items=getMapItems(opps.find(o=>o.id===oppId));
  if(!items[idx])return;
  items[idx].done=el.checked;
  saveMapItems(oppId,items);
  const row=el.closest('tr');
  if(el.checked)row.classList.add('map-done');else row.classList.remove('map-done');
  mapUpdateProgress(oppId);
}
function mapUpdateProgress(oppId){
  const items=getMapItems(opps.find(o=>o.id===oppId));
  const done=items.filter(i=>i.done&&!i.isSection).length;
  const total=items.filter(i=>!i.isSection).length;
  const pct=total?Math.round(done/total*100):0;
  const c=pct<30?'r':pct<60?'y':'g';
  const fill=document.getElementById('map-fill');
  if(fill){fill.style.width=pct+'%';fill.style.background='var(--'+c+')'}
  const lbl=document.getElementById('map-pct');
  if(lbl){lbl.textContent=done+'/'+total+' ('+pct+'%)';lbl.style.color='var(--'+c+')'}
}
function mapAddRow(oppId){
  const opp=opps.find(o=>o.id===oppId);
  const items=getMapItems(opp);
  items.push({date:'',done:false,milestone:'New milestone',ownerMerchant:'',ownerShopify:'',notes:''});
  saveMapItems(oppId,items);
  showDetail(oppId);
  // Switch to MAP tab
  setTimeout(()=>{const tabs=document.querySelectorAll('.tab');tabs.forEach(t=>{if(t.dataset.p==='map')t.click()})},50);
}
function mapAddSection(oppId){
  const opp=opps.find(o=>o.id===oppId);
  const items=getMapItems(opp);
  items.push({isSection:true,milestone:'NEW SECTION',done:false});
  saveMapItems(oppId,items);
  showDetail(oppId);
  setTimeout(()=>{const tabs=document.querySelectorAll('.tab');tabs.forEach(t=>{if(t.dataset.p==='map')t.click()})},50);
}
function mapDeleteRow(oppId,idx){
  const opp=opps.find(o=>o.id===oppId);
  const items=getMapItems(opp);
  items.splice(idx,1);
  saveMapItems(oppId,items);
  showDetail(oppId);
  setTimeout(()=>{const tabs=document.querySelectorAll('.tab');tabs.forEach(t=>{if(t.dataset.p==='map')t.click()})},50);
}
let mapDragIdx=null;
function mapDragStart(e,idx){mapDragIdx=idx;e.dataTransfer.effectAllowed='move'}
function mapDrop(e,oppId,targetIdx){
  e.preventDefault();
  if(mapDragIdx===null||mapDragIdx===targetIdx)return;
  const opp=opps.find(o=>o.id===oppId);
  const items=getMapItems(opp);
  const moved=items.splice(mapDragIdx,1)[0];
  items.splice(targetIdx,0,moved);
  saveMapItems(oppId,items);
  mapDragIdx=null;
  showDetail(oppId);
  setTimeout(()=>{const tabs=document.querySelectorAll('.tab');tabs.forEach(t=>{if(t.dataset.p==='map')t.click()})},50);
}
function mapMetaEdit(oppId,field,value){
  const opp=opps.find(o=>o.id===oppId);
  const meta=getMapMeta(opp);
  meta[field]=value.trim();
  saveMapMeta(oppId,meta);
}

// ============================================================
// COACHING DRILL-DOWN
// ============================================================
function showCoachingDrilldown(owner){
  const owDeals=opps.filter(o=>o.owner===owner);
  if(!owDeals.length)return;
  // Build section-level time-series data from coachingSnapshots + history
  const secData={};
  secNames.forEach(s=>{secData[s]={snapshots:[],current:0}});
  // Gather all snapshot dates across deals for this owner
  const allDates=new Set();
  owDeals.forEach(o=>{
    (o.coachingSnapshots||[]).forEach(snap=>allDates.add(snap.date));
    (o.history||[]).forEach(h=>allDates.add(h.date));
  });
  const sortedDates=[...allDates].sort();
  // For each date, compute aggregate section scores across all owner's deals
  sortedDates.forEach(date=>{
    secNames.forEach(secName=>{
      let totalScore=0,totalMax=0;
      owDeals.forEach(o=>{
        // Find the closest snapshot/history entry for this date
        const snap=(o.coachingSnapshots||[]).find(s=>s.date===date);
        const hist=(o.history||[]).find(h=>h.date===date);
        if(snap&&snap.sections[secName]){
          totalScore+=snap.sections[secName].score;
          totalMax+=snap.sections[secName].max;
        }else if(hist&&hist.sectionScores&&hist.sectionScores[secName]!=null){
          // history stores scores but not max, derive from meddpicc
          const sec=Object.values(o.meddpicc||{}).find(s=>s.label===secName);
          totalScore+=hist.sectionScores[secName];
          totalMax+=sec?sec.questions.length:7;
        }
      });
      if(totalMax>0){
        secData[secName].snapshots.push({date,pct:Math.round(totalScore/totalMax*100),score:totalScore,max:totalMax});
      }
    });
  });
  // Compute current values
  secNames.forEach(s=>{
    const snaps=secData[s].snapshots;
    secData[s].current=snaps.length?snaps[snaps.length-1].pct:0;
  });
  // Compute per-deal breakdown for current
  const dealBreakdown=owDeals.map(o=>{
    const dd={name:o.accountName,id:o.id,sections:{}};
    secNames.forEach(secName=>{
      const sec=Object.values(o.meddpicc||{}).find(s=>s.label===secName);
      if(sec){
        const score=sec.questions.reduce((s,q)=>s+(q.score||0),0);
        dd.sections[secName]={score,max:sec.questions.length,pct:sec.questions.length?Math.round(score/sec.questions.length*100):0};
      }else{dd.sections[secName]={score:0,max:0,pct:0}}
    });
    return dd;
  });
  // Find improving/declining (compare first vs last snapshot)
  const trends=secNames.map(s=>{
    const snaps=secData[s].snapshots;
    if(snaps.length<2)return{name:s,delta:0,dir:'new',current:secData[s].current};
    const first=snaps[0].pct,last=snaps[snaps.length-1].pct;
    return{name:s,delta:last-first,dir:last>first?'up':last<first?'down':'flat',current:last,first,last};
  }).sort((a,b)=>a.delta-b.delta);
  const declining=trends.filter(t=>t.dir==='down');
  const improving=trends.filter(t=>t.dir==='up');
  // Render modal
  const modal=document.createElement('div');
  modal.className='coach-modal';
  modal.onclick=e=>{if(e.target===modal)modal.remove()};
  const fn=owner.split(' ')[0];
  // Build sparkline SVGs for each section
  function sparkSVG(snaps,w,h){
    if(snaps.length<2)return'<span style="font-size:9px;color:var(--t3)">üìä baseline</span>';
    const minP=0,maxP=100;
    const pts=snaps.map((s,i)=>{
      const x=Math.round(i/(snaps.length-1)*w);
      const y=Math.round(h-(s.pct-minP)/(maxP-minP)*h);
      return x+','+y;
    }).join(' ');
    const lastPct=snaps[snaps.length-1].pct;
    const firstPct=snaps[0].pct;
    const col=lastPct>firstPct?'var(--g)':lastPct<firstPct?'var(--r)':'var(--y)';
    return'<svg width="'+w+'" height="'+h+'" style="display:block"><polyline points="'+pts+'" fill="none" stroke="'+col+'" stroke-width="2" stroke-linecap="round"/></svg>';
  }
  modal.innerHTML=`<div class="coach-panel">
    <div class="coach-panel-head">
      <h2><span style="width:32px;height:32px;border-radius:50%;background:var(--s3);display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--bl)">${ini(owner)}</span> ${owner} ‚Äî MEDDPICC Trends</h2>
      <button class="coach-close" onclick="this.closest('.coach-modal').remove()">‚úï</button>
    </div>
    <div style="padding:16px 20px">
      <p style="color:var(--t3);font-size:12px;margin-bottom:16px">Tracking ${fn}'s MEDDPICC performance across ${owDeals.length} deal${owDeals.length>1?'s':''}. Baseline: ${sortedDates[0]||'today'}. As you coach and refresh deals, trends will appear here.</p>
      ${declining.length?`<div style="background:var(--r-bg);border:1px solid var(--r-b);border-radius:8px;padding:10px 14px;margin-bottom:14px">
        <div style="font-size:11px;font-weight:700;color:var(--r);margin-bottom:4px">‚ö† Declining Areas</div>
        <div style="font-size:12px;color:var(--t);line-height:1.6">${declining.map(t=>'<b>'+t.name+'</b> dropped '+Math.abs(t.delta)+'pts ('+t.first+'% ‚Üí '+t.last+'%)').join(', ')}</div>
      </div>`:''}
      ${improving.length?`<div style="background:var(--g-bg);border:1px solid var(--g-b);border-radius:8px;padding:10px 14px;margin-bottom:14px">
        <div style="font-size:11px;font-weight:700;color:var(--g);margin-bottom:4px">üìà Improving Areas</div>
        <div style="font-size:12px;color:var(--t);line-height:1.6">${improving.map(t=>'<b>'+t.name+'</b> up +'+t.delta+'pts ('+t.first+'% ‚Üí '+t.last+'%)').join(', ')}</div>
      </div>`:''}
      <h3 style="font-size:14px;font-weight:700;margin-bottom:12px">Section Scores Over Time</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:10px;margin-bottom:20px">
      ${secNames.map(secName=>{
        const sd=secData[secName];
        const snaps=sd.snapshots;
        const bc=sd.current<40?'r':sd.current<65?'y':'g';
        const trend=trends.find(t=>t.name===secName)||{delta:0,dir:'flat'};
        const tIcon=trend.dir==='up'?'<span style="color:var(--g)">‚ñ≤ +'+trend.delta+'</span>':trend.dir==='down'?'<span style="color:var(--r)">‚ñº '+trend.delta+'</span>':'<span style="color:var(--t3)">‚Äî baseline</span>';
        return'<div style="background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:12px 14px">'
          +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">'
          +'<div style="font-size:12px;font-weight:700">'+secName+'</div>'
          +'<div style="display:flex;align-items:center;gap:8px">'
          +'<span style="font-size:20px;font-weight:800;color:var(--'+bc+')">'+sd.current+'%</span>'
          +'<span style="font-size:10px">'+tIcon+'</span></div></div>'
          +'<div style="margin-bottom:8px">'+sparkSVG(snaps,340,40)+'</div>'
          +'<div style="display:flex;gap:4px;flex-wrap:wrap">'
          +dealBreakdown.map(d=>{
            const ds=d.sections[secName];
            const dc=ds.pct<40?'r':ds.pct<65?'y':'g';
            return'<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:var(--'+dc+'-bg);color:var(--'+dc+');border:1px solid var(--'+dc+'-b);cursor:pointer" onclick="event.stopPropagation();document.querySelector(\'.coach-modal\').remove();showDetail(\''+d.id+'\')" title="'+d.name+'">'+d.name.split(' ')[0]+' '+ds.score+'/'+ds.max+'</span>';
          }).join('')
          +'</div></div>'}).join('')}
      </div>
      <h3 style="font-size:14px;font-weight:700;margin-bottom:10px">Per-Deal Breakdown</h3>
      <table style="border-radius:10px"><thead><tr><th>Deal</th>${secNames.map(s=>'<th style="text-align:center;font-size:8px">'+s.replace('Economic ','Econ ').replace('Decision ','Dec ').replace('Identify ','ID ')+'</th>').join('')}<th style="text-align:center">Total</th></tr></thead>
      <tbody>${dealBreakdown.map(d=>{
        let rowTotal=0,rowMax=0;
        return'<tr onclick="document.querySelector(\'.coach-modal\').remove();showDetail(\''+d.id+'\')" style="cursor:pointer"><td style="font-weight:600;font-size:11px">'+d.name+'</td>'
          +secNames.map(s=>{const ds=d.sections[s];rowTotal+=ds.score;rowMax+=ds.max;const dc=ds.pct<40?'r':ds.pct<65?'y':'g';return'<td style="text-align:center;font-size:11px;font-weight:700;color:var(--'+dc+')">'+ds.pct+'%</td>'}).join('')
          +'<td style="text-align:center;font-size:11px;font-weight:800">'+(rowMax?Math.round(rowTotal/rowMax*100):0)+'%</td></tr>'}).join('')}
      </tbody></table>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

// ============================================================
// NAV
// ============================================================
// Action items helpers
function getActionsForDeal(o){
  const actions=[];
  Object.entries(o.meddpicc||{}).forEach(([k,sec])=>{
    (sec.questions||[]).forEach(q=>{
      if(q.action&&q.action!=='N/A'&&q.action!==''){
        actions.push({cat:sec.label||k,rec:q.action,due:q.due||'',notes:q.notes||''});
      }
    });
  });
  // Sort: overdue first, then by due date, then no-date last
  return actions.sort((a,b)=>{
    const aOd=a.due&&isOverdue(a.due)?0:1;
    const bOd=b.due&&isOverdue(b.due)?0:1;
    if(aOd!==bOd)return aOd-bOd;
    if(a.due&&b.due)return new Date(normDate(a.due))-new Date(normDate(b.due));
    if(a.due&&!b.due)return-1;
    if(!a.due&&b.due)return 1;
    return 0;
  }).slice(0,8); // Top 8 per deal
}
function normDate(d){if(!d)return'';if(d.includes('/'))return d.replace(/(\d{2})\/(\d{2})\/(\d{4})/,'$3-$1-$2');return d}
function isOverdue(d){if(!d)return false;try{const dt=new Date(normDate(d));const today=new Date();today.setHours(0,0,0,0);return dt<today}catch(e){return false}}
function toggleAction2(checkId,el){
  const row=el.closest('tr');
  if(el.checked){localStorage.setItem(checkId,'done');row.style.opacity='.4';row.style.textDecoration='line-through'}
  else{localStorage.removeItem(checkId);row.style.opacity='1';row.style.textDecoration='none'}
}
function goHome(){history.replaceState(null,null,' ');currentOpp=null;renderList()}
function goBack(){goHome()}
window.addEventListener('hashchange',()=>{const h=location.hash.replace('#','');if(h)showDetail(h);else renderList()});

// ============================================================
// ORG CHART ‚Äî Drag & Drop Hierarchy
// ============================================================
function getOrgLayout(oppId){
  try{return JSON.parse(localStorage.getItem('orgchart_'+oppId))||null}catch(e){return null}
}
function saveOrgLayout(oppId,layout){
  localStorage.setItem('orgchart_'+oppId,JSON.stringify(layout));
  toast('‚úì Org chart saved');
}
function resetOrgChart(oppId){
  localStorage.removeItem('orgchart_'+oppId);
  const opp=opps.find(o=>o.id===oppId);
  if(opp)renderOrgChart(opp);
  toast('‚Ü∫ Org chart reset');
}

// Infer default hierarchy from titles/roles
function inferOrgHierarchy(stakeholders){
  const people=stakeholders.map((s,i)=>({
    id:'s_'+i,
    name:s.name,
    title:s.title||'',
    role:s.role||'Contact',
    engagement:s.engagement||'none',
    email:s.email||'',
    callsAttended:s.callsAttended||0,
    callsInvited:s.callsInvited||0,
    type:'merchant'
  }));

  // Title-based seniority scoring
  function seniority(p){
    const t=(p.title+' '+p.role).toLowerCase();
    if(/\b(ceo|cto|cfo|coo|cmo|chief|founder|president|owner|managing director)\b/.test(t))return 100;
    if(/\b(vp|vice president|svp|evp|gvp)\b/.test(t))return 90;
    if(/\b(director|head of)\b/.test(t))return 80;
    if(/\b(senior manager|sr manager|principal)\b/.test(t))return 70;
    if(/\b(manager)\b/.test(t))return 60;
    if(/\b(lead|senior|sr\.?)\b/.test(t))return 50;
    if(/\b(specialist|analyst|coordinator|associate)\b/.test(t))return 30;
    // Role-based fallback
    if(p.role==='Economic Buyer'||p.role==='Decision Maker')return 85;
    if(p.role==='Champion')return 65;
    if(p.role==='Evaluator')return 55;
    if(p.role==='Influencer')return 45;
    return 20;
  }

  people.sort((a,b)=>seniority(b)-seniority(a));

  // Build tree: highest seniority is root, then group by seniority tiers
  const tree={};
  if(people.length===0)return{tree:{},rootId:null};

  const root=people[0];
  tree[root.id]={...root,parentId:null,children:[]};

  // Group remaining people into tiers under appropriate parents
  const tiers=[];
  let currentTier=[];
  let currentScore=seniority(people[0]);

  for(let i=1;i<people.length;i++){
    const s=seniority(people[i]);
    if(Math.abs(s-currentScore)<=10){
      currentTier.push(people[i]);
    }else{
      if(currentTier.length)tiers.push([...currentTier]);
      currentTier=[people[i]];
      currentScore=s;
    }
  }
  if(currentTier.length)tiers.push(currentTier);

  // First tier reports to root
  let parentIds=[root.id];
  for(const tier of tiers){
    const newParentIds=[];
    tier.forEach((p,i)=>{
      // Distribute among parents
      const parentIdx=Math.min(i,parentIds.length-1);
      const parentId=parentIds[parentIdx];
      tree[p.id]={...p,parentId:parentId,children:[]};
      tree[parentId].children.push(p.id);
      newParentIds.push(p.id);
    });
    if(newParentIds.length)parentIds=newParentIds;
  }

  return{tree,rootId:root.id};
}

// Convert saved layout format to tree
function layoutToTree(layout,stakeholders){
  const people=stakeholders.map((s,i)=>({
    id:'s_'+i,name:s.name,title:s.title||'',role:s.role||'Contact',
    engagement:s.engagement||'none',email:s.email||'',
    callsAttended:s.callsAttended||0,callsInvited:s.callsInvited||0,type:'merchant'
  }));
  const pMap={};
  people.forEach(p=>pMap[p.id]=p);

  const tree={};
  let rootId=layout.rootId;

  // Rebuild tree from layout
  for(const[id,node]of Object.entries(layout.tree)){
    if(!pMap[id])continue;
    tree[id]={...pMap[id],parentId:node.parentId,children:(node.children||[]).filter(c=>pMap[c])};
  }
  // Add any new stakeholders not in saved layout
  people.forEach(p=>{
    if(!tree[p.id])tree[p.id]={...p,parentId:null,children:[]};
  });

  return{tree,rootId};
}

let orgDragState=null;

function renderOrgChart(opp){
  const container=document.getElementById('orgchart-'+opp.id);
  if(!container)return;

  const stakeholders=opp.stakeholders||[];
  if(!stakeholders.length){container.innerHTML='<p style="color:var(--t3);font-size:12px">No stakeholders to display.</p>';return;}

  const saved=getOrgLayout(opp.id);
  let {tree,rootId}=saved?layoutToTree(saved,stakeholders):inferOrgHierarchy(stakeholders);

  // Find unassigned (no parent & not root)
  const unassigned=Object.values(tree).filter(n=>n.id!==rootId&&n.parentId===null);

  function roleClass(r){
    if(r==='Decision Maker'||r==='Economic Buyer'||r==='Signatory')return 'dm';
    if(r==='Evaluator')return 'ev';
    if(r==='Influencer')return 'inf';
    if(r==='Champion')return 'ch';
    return '';
  }

  function renderNode(nodeId,depth){
    const n=tree[nodeId];
    if(!n)return '';
    const rc=roleClass(n.role);
    const eng=n.engagement||'none';
    const engLabel=eng.charAt(0).toUpperCase()+eng.slice(1);
    const children=(n.children||[]).filter(c=>tree[c]);

    return `<div class="org-node-wrap" data-depth="${depth}">
      <div class="org-node" draggable="true" data-node-id="${n.id}" data-opp-id="${opp.id}"
        ondragstart="orgDragStart(event)" ondragend="orgDragEnd(event)"
        ondragover="orgDragOver(event)" ondragenter="orgDragEnter(event)"
        ondragleave="orgDragLeave(event)" ondrop="orgDrop(event)">
        <div class="on-avatar merchant">${ini(n.name)}</div>
        <div class="on-name">${n.name}</div>
        <div class="on-title">${n.title}</div>
        <span class="on-role ${rc}">${n.role}</span>
        <div class="on-eng"><span class="dot ${eng}"></span>${engLabel} engagement${n.callsAttended?' ¬∑ '+n.callsAttended+' calls':''}</div>
      </div>
      ${children.length?`
        <div class="org-connector-down"></div>
        <div class="org-children">
          ${children.map(c=>`<div class="org-child-branch">
            <div class="org-connector"></div>
            ${renderNode(c,depth+1)}
          </div>`).join('')}
        </div>
      `:''}
    </div>`;
  }

  let html='<div class="org-tree">';
  if(rootId&&tree[rootId]){
    html+=renderNode(rootId,0);
  }
  html+='</div>';

  // Unassigned people pool
  if(unassigned.length){
    html+=`<div class="org-unassigned">
      <h4>üìã Unassigned Contacts (${unassigned.length}) ‚Äî drag onto a person above to assign</h4>
      <div class="org-unassigned-list">
        ${unassigned.map(n=>{
          const rc=roleClass(n.role);
          const eng=n.engagement||'none';
          return `<div class="org-node" draggable="true" data-node-id="${n.id}" data-opp-id="${opp.id}"
            ondragstart="orgDragStart(event)" ondragend="orgDragEnd(event)"
            ondragover="orgDragOver(event)" ondragenter="orgDragEnter(event)"
            ondragleave="orgDragLeave(event)" ondrop="orgDrop(event)">
            <div class="on-avatar merchant" style="width:32px;height:32px;font-size:11px">${ini(n.name)}</div>
            <div class="on-name">${n.name}</div>
            <div class="on-title">${n.title}</div>
            <span class="on-role ${rc}">${n.role}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  container.innerHTML=html;
}

function orgDragStart(e){
  const nodeId=e.target.closest('.org-node').dataset.nodeId;
  const oppId=e.target.closest('.org-node').dataset.oppId;
  orgDragState={nodeId,oppId};
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',nodeId);
  setTimeout(()=>e.target.closest('.org-node').classList.add('dragging'),0);
}

function orgDragEnd(e){
  orgDragState=null;
  document.querySelectorAll('.org-node.dragging').forEach(n=>n.classList.remove('dragging'));
  document.querySelectorAll('.org-node.drag-over').forEach(n=>n.classList.remove('drag-over'));
}

function orgDragOver(e){
  e.preventDefault();
  e.dataTransfer.dropEffect='move';
}

function orgDragEnter(e){
  e.preventDefault();
  const target=e.target.closest('.org-node');
  if(target&&orgDragState&&target.dataset.nodeId!==orgDragState.nodeId){
    target.classList.add('drag-over');
  }
}

function orgDragLeave(e){
  const target=e.target.closest('.org-node');
  if(target)target.classList.remove('drag-over');
}

function orgDrop(e){
  e.preventDefault();
  const targetNode=e.target.closest('.org-node');
  if(!targetNode||!orgDragState)return;
  targetNode.classList.remove('drag-over');

  const draggedId=orgDragState.nodeId;
  const targetId=targetNode.dataset.nodeId;
  const oppId=orgDragState.oppId;

  if(draggedId===targetId)return;

  const opp=opps.find(o=>o.id===oppId);
  if(!opp)return;

  const stakeholders=opp.stakeholders||[];
  const saved=getOrgLayout(oppId);
  let {tree,rootId}=saved?layoutToTree(saved,stakeholders):inferOrgHierarchy(stakeholders);

  // Check for circular reference ‚Äî can't drop onto own descendant
  function isDescendant(parentId,childId){
    if(!tree[parentId])return false;
    const children=tree[parentId].children||[];
    if(children.includes(childId))return true;
    return children.some(c=>isDescendant(c,childId));
  }
  if(isDescendant(draggedId,targetId))return; // Prevent circular

  // Remove dragged from old parent's children
  const oldParentId=tree[draggedId]?.parentId;
  if(oldParentId&&tree[oldParentId]){
    tree[oldParentId].children=tree[oldParentId].children.filter(c=>c!==draggedId);
  }

  // If dragged was root, promote first child as new root
  if(draggedId===rootId){
    const draggedChildren=tree[draggedId].children||[];
    if(draggedChildren.length){
      rootId=draggedChildren[0];
      tree[rootId].parentId=null;
      // Remaining children of old root become children of new root
      for(let i=1;i<draggedChildren.length;i++){
        tree[draggedChildren[i]].parentId=rootId;
        tree[rootId].children.push(draggedChildren[i]);
      }
    }
  }

  // Add dragged as child of target
  tree[draggedId].parentId=targetId;
  tree[draggedId].children=tree[draggedId].children||[];
  if(!tree[targetId].children)tree[targetId].children=[];
  if(!tree[targetId].children.includes(draggedId)){
    tree[targetId].children.push(draggedId);
  }

  // Save the layout (only store ids, parentId, children)
  const saveTree={};
  for(const[id,node]of Object.entries(tree)){
    saveTree[id]={parentId:node.parentId,children:node.children||[]};
  }
  saveOrgLayout(oppId,{tree:saveTree,rootId});

  // Re-render
  renderOrgChart(opp);
}

// ============================================================
// INIT
// ============================================================
(async()=>{
  await loadCloudComments();
  const h=location.hash.replace('#','');
  if(h&&opps.find(o=>o.id===h))showDetail(h);else renderList();
})();
</script>
</body>
</html>